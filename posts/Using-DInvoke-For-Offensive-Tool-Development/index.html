<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Using D/Invoke for Offensive Tool Development in C#" /><meta name="author" content="crypt0ace" /><meta property="og:locale" content="en" /><meta name="description" content="Using D/Invoke for Offensive Tool Development in C#" /><meta property="og:description" content="Using D/Invoke for Offensive Tool Development in C#" /><link rel="canonical" href="https://crypt0ace.github.io/posts/Using-DInvoke-For-Offensive-Tool-Development/" /><meta property="og:url" content="https://crypt0ace.github.io/posts/Using-DInvoke-For-Offensive-Tool-Development/" /><meta property="og:site_name" content="Crypt0ace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-01T00:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Using D/Invoke for Offensive Tool Development in C#" /><meta name="twitter:site" content="@crypt0acee" /><meta name="twitter:creator" content="@crypt0ace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"crypt0ace"},"dateModified":"2022-10-02T00:02:26+05:00","datePublished":"2022-10-01T00:00:00+05:00","description":"Using D/Invoke for Offensive Tool Development in C#","headline":"Using D/Invoke for Offensive Tool Development in C#","mainEntityOfPage":{"@type":"WebPage","@id":"https://crypt0ace.github.io/posts/Using-DInvoke-For-Offensive-Tool-Development/"},"url":"https://crypt0ace.github.io/posts/Using-DInvoke-For-Offensive-Tool-Development/"}</script><title>Using D/Invoke for Offensive Tool Development in C# | Crypt0ace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Crypt0ace"><meta name="application-name" content="Crypt0ace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Crypt0ace</a></div><div class="site-subtitle font-italic">A Cybersecurity Blog by Ahmed Sher</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/crypt0ace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/crypt0acee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahmedsherfreelance','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmed-sher-93234a206/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Using D/Invoke for Offensive Tool Development in C#</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Using D/Invoke for Offensive Tool Development in C#</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1664564400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 1, 2022 </em> </span> <span> Updated <em class="" data-ts="1664650946" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 2, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Ahmed Sher </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1493 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction:</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In this post we are going to have a look into the <a href="https://github.com/TheWover/DInvoke">D/Invoke</a> project by <a href="https://github.com/TheWover">TheWover</a>. He also wrote a really good blog post which you can read <a href="https://thewover.github.io/Dynamic-Invoke/">here</a> where he demonstrates in detail how the whole project works. It covers some really cool aspects so its highly recommended to check it out. This post mainly focuses on creating a shellcode injection tool using all the methods that he specifies in his blog. <br /> Sharpsploit also has integrated D/Invoke in their project which can be read about <a href="https://github.com/cobbr/SharpSploit/blob/master/SharpSploit/SharpSploit%20-%20Quick%20Command%20Reference.md#sharpsploitexecutiondynamicinvoke">here</a>.</p><h2 id="what-is-dinvoke"><span class="mr-2">What is D/Invoke</span><a href="#what-is-dinvoke" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I have talked about what P/Invoke or Platform Invoke is in the previous posts (<a href="https://crypt0ace.github.io/posts/WinAPI-and-PInvoke-in-CSharp/">here</a> if youre interested). Its a great way to use WinAPI and unmanaged code into our managed C# code. But it has some issues for us as offensive tool developers. Its not really OPSEC safe. A lot of AVs/EDRs catch these tools easily. In the last post, I talked about how EDRs usually work by hooking into processes and how we can try and evade their detections by unhooking DLLs. A good method but still not OPSEC safe. What if the defenders look at those specific imports that are made to unhook the DLLs? What is they are looking at the suspicious imports? Thats where D/Invoke comes in. <br /> Using D/Invoke we can dynamically invoke (hence the name D/Invoke) during runtime from the DLL loaded in memory which can help us bypass API hooks and also the Import Address Table would not show any suspicious imports. <br /> The inner workings of some methods used in D/Invoke are similar to what I already have posted about. The classic method uses delegates almost similar to what I discussed <a href="https://crypt0ace.github.io/posts/Staying-under-the-Radar-Part-2/">here</a>, the mapping method is similar to what was discussed <a href="https://crypt0ace.github.io/posts/Staying-under-the-Radar-Part-3/">here</a>. But it takes a whole lot of work and makes things very simple and easy and some other cool features as well.</p><h2 id="using-dinvoke"><span class="mr-2">Using D/Invoke</span><a href="#using-dinvoke" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There’s 4 different ways we can use D/Invoke.</p><ul><li>Dynamic API Method (Classic Method)<li>Manual Mapping Method<li>Overload Mapping Method<li>Syscalls Method</ul><h3 id="dynamic-api-or-classic-method"><span class="mr-2">Dynamic API or Classic Method</span><a href="#dynamic-api-or-classic-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The simplest and easiest way to get started with D/Invoke is using teh dynamic API method. It is called using <code class="language-plaintext highlighter-rouge">DynamicAPIInvoke</code> and it uses <code class="language-plaintext highlighter-rouge">GetLibraryAddress</code> to locate the function specified from the module in memory or from disk. I have cloned the <a href="https://github.com/TheWover/DInvoke">D/Invoke</a> repo from github and added the D/Invoke folder in my solution on Visual Studio. Should be noted that this project is also available in nuget so you can get the DLL directly and use that too. For our demo, we are using these API calls</p><ul><li>OpenProcess<li>VirtualAllocEx<li>WriteProcessMemory<li>CreateRemoteThread</ul><p>I’m using the same example from <a href="https://github.com/crypt0ace/CS-ShellcodeInjection/">here</a> and porting it from P/Invoke to D/invoke so its going to follow the same logic. <br /> For using <code class="language-plaintext highlighter-rouge">OpenProces</code>, we would need to use <code class="language-plaintext highlighter-rouge">GetLibraryAddress</code> with 2 parameters. the DLL or module name, and the function call we need. Then we need a delegate with the parameters that the function needs because we are going to get a function pointer for that delegate which we can pass the arguments we need. Remember to add the namespace with <code class="language-plaintext highlighter-rouge">using DInvoke;</code> and keep an eye from where the methods are being called like <em><code class="language-plaintext highlighter-rouge">DInvoke.DynamicInvoke.Generic.</code></em><code class="language-plaintext highlighter-rouge">GetLibraryAddress()</code>.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// The Delegate</span>
<span class="p">[</span><span class="nf">UnmanagedFunctionPointer</span><span class="p">(</span><span class="n">CallingConvention</span><span class="p">.</span><span class="n">StdCall</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">delegate</span> <span class="n">IntPtr</span> <span class="nf">OpenProcessD</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bInheritHandle</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">dwProcessId</span><span class="p">);</span>

<span class="c1">// The Function Call</span>
<span class="n">ptr</span> <span class="p">=</span> <span class="n">DInvoke</span><span class="p">.</span><span class="n">DynamicInvoke</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="nf">GetLibraryAddress</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="s">"OpenProcess"</span><span class="p">);</span>
<span class="n">OpenProcessD</span> <span class="n">OpenProcess</span> <span class="p">=</span> <span class="p">(</span><span class="n">OpenProcessD</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">GetDelegateForFunctionPointer</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">OpenProcessD</span><span class="p">));</span>
<span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="nf">OpenProcess</span><span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">desiredAccess</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">processId</span><span class="p">);</span>
</pre></table></code></div></div><p>Its this simple to get a dynamic API call working. Another way is to use this is to first create a object array to store our parameters. Then use <code class="language-plaintext highlighter-rouge">DynamicAPIInvoke</code> with 4 parameters. The DLL or module name, function call, the delegate and then a reference to the object array of arguments that were specified.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Also needs the delegate</span>
<span class="kt">object</span><span class="p">[]</span> <span class="n">OpenProcessArgs</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">desiredAccess</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">processId</span> <span class="p">};</span>
<span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">DInvoke</span><span class="p">.</span><span class="n">DynamicInvoke</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="nf">DynamicAPIInvoke</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="s">"OpenProcess"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">OpenProcessD</span><span class="p">),</span> <span class="k">ref</span> <span class="n">OpenProcessArgs</span><span class="p">);</span>
</pre></table></code></div></div><p>Both of these are similar with how they work. Using the same method we can port all the other API calls to D/Invoke. The full source code is mentioned at the end.</p><h3 id="manual-mapping"><span class="mr-2">Manual Mapping</span><a href="#manual-mapping" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you read the last post about unhooking DLLs in which we mapped a fresh copy of NTDLL in memory by getting a handle to the DLL on disk mapping it in memory using all sorts of APIs then manually rewritting the <code class="language-plaintext highlighter-rouge">.text</code> section with our new fresh DLL. Using D/Invoke, all this can be summarized in just 2 lines of code.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PE</span><span class="p">.</span><span class="n">PE_MANUAL_MAP</span> <span class="n">mappedDLL</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PE</span><span class="p">.</span><span class="nf">PE_MANUAL_MAP</span><span class="p">();</span>
<span class="n">mappedDLL</span> <span class="p">=</span> <span class="n">DInvoke</span><span class="p">.</span><span class="n">ManualMap</span><span class="p">.</span><span class="n">Map</span><span class="p">.</span><span class="nf">MapModuleToMemory</span><span class="p">(</span><span class="s">@"C:\Windows\System32\kernel32.dll"</span><span class="p">);</span>
</pre></table></code></div></div><p>Best case is to use <code class="language-plaintext highlighter-rouge">ntdll.dll</code> because if <code class="language-plaintext highlighter-rouge">kernel32.dll</code> calls APIs from <code class="language-plaintext highlighter-rouge">NTDLL.dll</code> that are hooked by AV/EDR it will get caught but in this case Im going to be using <code class="language-plaintext highlighter-rouge">kernel32.dll</code> to make it simpler. <br /> The rest of the code is similar. We need to specify a delegate for our function just like before, and object array of arguments we need and then we use <code class="language-plaintext highlighter-rouge">CallMappedDLLModuleExport</code> with 6 arguments. The <code class="language-plaintext highlighter-rouge">PEINFO</code> struct of our newly mapped DLL, the module base address of our DLL, the function name we need, the delegate, function arguments and wether or not the DLLMain method is needed to be called. Calling from modules like <code class="language-plaintext highlighter-rouge">kernel32.dll</code> or <code class="language-plaintext highlighter-rouge">NTDLL.dll</code> etc set this to false.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">object</span><span class="p">[]</span> <span class="n">OpenProcessArgs</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">desiredAccess</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">processId</span> <span class="p">};</span>
<span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">DInvoke</span><span class="p">.</span><span class="n">DynamicInvoke</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="nf">CallMappedDLLModuleExport</span><span class="p">(</span><span class="n">mappedDLL</span><span class="p">.</span><span class="n">PEINFO</span><span class="p">,</span> <span class="n">mappedDLL</span><span class="p">.</span><span class="n">ModuleBase</span><span class="p">,</span> <span class="s">"OpenProcess"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">OpenProcessD</span><span class="p">),</span> <span class="n">OpenProcessArgs</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></table></code></div></div><p>Using this way we can put together the other APIs as well and get our shellcode executed. No need to map the same module again. Just use the <code class="language-plaintext highlighter-rouge">CallMappedDLLModuleExport</code> in case you’re using the same DLL.</p><h3 id="overload-mapping"><span class="mr-2">Overload Mapping</span><a href="#overload-mapping" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Very similar to manual mapping method with one key difference. According to the blog by TheWover <br /> <em>Module Overloading allows you to store a payload in memory (in a byte array) into memory backed by a legitimate file on disk. That way, when you execute code from it, the code will appear to execute from a legitimate, validly signed DLL on disk.</em> <br /> This method makes it more stealthier. Usuage is the same as manual mapping.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PE</span><span class="p">.</span><span class="n">PE_MANUAL_MAP</span> <span class="n">mappedDLL</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PE</span><span class="p">.</span><span class="nf">PE_MANUAL_MAP</span><span class="p">();</span>
<span class="n">mappedDLL</span> <span class="p">=</span> <span class="n">DInvoke</span><span class="p">.</span><span class="n">ManualMap</span><span class="p">.</span><span class="n">Overload</span><span class="p">.</span><span class="nf">OverloadModule</span><span class="p">(</span><span class="s">@"C:\Windows\System32\kernel32.dll"</span><span class="p">);</span>
</pre></table></code></div></div><p>And then we can call the functions using the same way as before.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">object</span><span class="p">[]</span> <span class="n">OpenProcessArgs</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">desiredAccess</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">processId</span> <span class="p">};</span>
<span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">DInvoke</span><span class="p">.</span><span class="n">DynamicInvoke</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="nf">CallMappedDLLModuleExport</span><span class="p">(</span><span class="n">mappedDLL</span><span class="p">.</span><span class="n">PEINFO</span><span class="p">,</span> <span class="n">mappedDLL</span><span class="p">.</span><span class="n">ModuleBase</span><span class="p">,</span> <span class="s">"OpenProcess"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">OpenProcessD</span><span class="p">),</span> <span class="n">OpenProcessArgs</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="syscalls"><span class="mr-2">Syscalls</span><a href="#syscalls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Syscalls can be explained in a whole other blog. Its the hot topic and very much used by advanced malware authors in order to evade AVs/EDRs. The summary is that because AVs/EDRs hook API calls like <code class="language-plaintext highlighter-rouge">OpenProcess</code>, offensive developers started to use <code class="language-plaintext highlighter-rouge">NtOpenProcess</code> from <code class="language-plaintext highlighter-rouge">NTDLL.dll</code> to which <code class="language-plaintext highlighter-rouge">OpenProcess</code> gets transfered anyways for transition into kernel land. When AVs/EDRs caught up to this they started to hook into <code class="language-plaintext highlighter-rouge">Nt*</code> functions as well. Then came syscalls. Looking up the <code class="language-plaintext highlighter-rouge">NTDLL.dll</code> in memory and calculating where the syscall for the function is and using it to get directly to the kernel avoiding the hooks. <br /> This small summary doent do justice to the whole theory of syscalls wo its recommended to read up further on this topic. SOme refernces are provided at the end. <br /> This technique is a bit trickier and took some time until I figured it out. The issue were 2 things.</p><ul><li>Identifying what userland calls get forwarded to what kernel mode calls.<li>What arguments are supposed to be provided to the <code class="language-plaintext highlighter-rouge">Nt*</code> calls.</ul><p>We can use the <code class="language-plaintext highlighter-rouge">GetSyscallStub</code> function from D/Invoke with the function name we want. We dont need to provide any DLL because it will always look up form <code class="language-plaintext highlighter-rouge">NTDLL.dll</code>. Then next step is to get a funtion pointer for our delegate. And then we use the <code class="language-plaintext highlighter-rouge">NtOpenProcess</code> call. For the arguments that we need to provide i took a look at three resources.</p><ul><li><a href="https://www.pinvoke.net/index.aspx">PInvoke.net</a><li><a href="https://dinvoke.net/">DInvoke.net</a><li><a href="http://undocumented.ntinternals.net/">Undocumented APIs</a></ul><p>These calls also use the NTSTATUS struct. So we can initialize the syscall stub and the marshaling using this.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">syscall</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
<span class="n">syscall</span> <span class="p">=</span> <span class="n">DInvoke</span><span class="p">.</span><span class="n">DynamicInvoke</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="nf">GetSyscallStub</span><span class="p">(</span><span class="s">"NtOpenProcess"</span><span class="p">);</span>
<span class="n">NtOpenProcess</span> <span class="n">NtOpenProcess</span> <span class="p">=</span> <span class="p">(</span><span class="n">NtOpenProcess</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">GetDelegateForFunctionPointer</span><span class="p">(</span><span class="n">syscall</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">NtOpenProcess</span><span class="p">));</span>
</pre></table></code></div></div><p>Then we can provide the arguments as this.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kt">var</span> <span class="n">oa</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Native</span><span class="p">.</span><span class="nf">OBJECT_ATTRIBUTES</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">cid</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Native</span><span class="p">.</span><span class="n">CLIENT_ID</span>
<span class="p">{</span>
  <span class="n">UniqueProcess</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span><span class="n">processId</span>
<span class="p">};</span>
<span class="kt">var</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
<span class="n">Native</span><span class="p">.</span><span class="n">NTSTATUS</span> <span class="n">status</span> <span class="p">=</span> <span class="nf">NtOpenProcess</span><span class="p">(</span><span class="k">ref</span> <span class="n">procHandle</span><span class="p">,</span> <span class="n">desiredAccess</span><span class="p">,</span> <span class="k">ref</span> <span class="n">oa</span><span class="p">,</span> <span class="k">ref</span> <span class="n">cid</span><span class="p">);</span>
</pre></table></code></div></div><p>This way we can do all the APIs as well.</p><h2 id="code"><span class="mr-2">Code</span><a href="#code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The full source code demonstrating all the methods can be looked at <a href="https://github.com/crypt0ace/CS-ShellcodeInjection/tree/main/DInvoke">here</a>. Provide the tool with a process ID as argument and you can specify the method by uncomenting the method you want to use.</p><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Credits to the work these amazing researchers</p><ul><li><a href="https://github.com/TheWover/DInvoke">D/Invoke - TheWover</a><li><a href="https://thewover.github.io/Dynamic-Invoke/">Emulating Covert Operations - Dynamic Invocation (Avoiding PInvoke &amp; API Hooks) - TheWover</a><li><a href="https://blog.nviso.eu/2020/11/20/dynamic-invocation-in-net-to-bypass-hooks/">Dynamic Invocation in .NET to bypass hooks - NVISO Labs</a><li><a href="https://offensivedefence.co.uk/posts/dinvoke-syscalls/">Syscalls with D/Invoke - Rasta Mouse</a><li><a href="https://s3cur3th1ssh1t.github.io/A-tale-of-EDR-bypass-methods/">A tale of EDR bypass methods - s3cur3th1ssh1t</a><li><a href="https://ppn.snovvcrash.rocks/red-team/maldev/dinvoke">Dynamic API Invocation</a><li><a href="https://www.ired.team/offensive-security/defense-evasion/using-syscalls-directly-from-visual-studio-to-bypass-avs-edrs">Calling Syscalls Directly from Visual Studio to Bypass AVs/EDRs - IRedTeam</a><li><a href="https://medium.com/@merasor07/av-edr-evasion-using-direct-system-calls-user-mode-vs-kernel-mode-fad2fdfed01a">AV/EDR Evasion Using Direct System Calls (User-Mode vs kernel-Mode) - Usman Sikander</a><li><a href="https://pwnedcoffee.com/blog/red-team-tactics/bypassing-antivirus-using-direct-system-calls/">Bypassing Antivirus using Direct System Calls - nag0mez</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/red-team/" class="post-tag no-text-decoration" >Red Team</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Using+D%2FInvoke+for+Offensive+Tool+Development+in+C%23+-+Crypt0ace&url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FUsing-DInvoke-For-Offensive-Tool-Development%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Using+D%2FInvoke+for+Offensive+Tool+Development+in+C%23+-+Crypt0ace&u=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FUsing-DInvoke-For-Offensive-Tool-Development%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FUsing-DInvoke-For-Offensive-Tool-Development%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NHA-Part-3/">AD Pwnage: Ninja Hackers Academy Part 3</a><li><a href="/posts/NHA-Part-2/">AD Pwnage: Ninja Hackers Academy Part 2</a><li><a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/">Using D/Invoke for Offensive Tool Development in C#</a><li><a href="/posts/Staying-under-the-Radar-Part-2/">Staying Under the Radar - Part 2 - Hiding IAT using Delegates</a><li><a href="/posts/Shellcode-Injection-Techniques/">Shellcode Injection in C# - Part 1 - Process Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-2/"><div class="card-body"> <em class="small" data-ts="1662663600" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 2 - Process Hollowing</h3><div class="text-muted small"><p> Introduction This post is part 2 of shellcode injection techniques. You can read part 1 here. In this one, we will look into Process Hollowing in C#. Process Hollowing Process Hollowing is a techn...</p></div></div></a></div><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/"><div class="card-body"> <em class="small" data-ts="1663268400" data-df="ll" > Sep 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</h3><div class="text-muted small"><p> Introduction In this post we are going to look at another method for shellcode execution. THis involves using the API call QueueUserAPC. Like previous Process Hollowing, in this we are going to ope...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar/"><div class="card-body"> <em class="small" data-ts="1663441200" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</h3><div class="text-muted small"><p> Introduction In this post we are going to look at two “features” (lol) that Microsoft provided which can allow us to spoof our parent process ID and also block third party DLLs that are not Microso...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Staying-under-the-Radar-Part-3/" class="btn btn-outline-primary" prompt="Older"><p>Staying Under the Radar - Part 3 - Unhooking DLLs</p></a> <a href="/posts/NHA-Part-1/" class="btn btn-outline-primary" prompt="Newer"><p>AD Pwnage: Ninja Hackers Academy Part 1</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/crypt0acee">Ahmed Sher</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
